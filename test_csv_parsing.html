<!DOCTYPE html>
<html>
<head>
    <title>CSV Parsing Test</title>
</head>
<body>
    <h1>CSV Parsing Debug Test</h1>
    <div id="output"></div>

    <script>
        // Copy of parseCSVLine function from ImportExportModule.js
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quotes
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            // Add last field
            result.push(current.trim());

            return result;
        }

        // Copy of mapColumns function
        function mapColumns(headers) {
            const map = {};

            console.log('[ImportExportModule] Mapping columns from headers:', headers);

            headers.forEach((header, index) => {
                // Clean header: trim whitespace and normalize case
                const normalized = header.toLowerCase().trim();

                console.log(`  [${index}] "${header}" -> normalized: "${normalized}"`);

                if (normalized.includes('field id')) {
                    map.field_id = index;
                } else if (normalized.includes('field name')) {
                    map.field_name = index;
                } else if (normalized.includes('entity id')) {
                    map.entity_id = index;
                } else if (normalized.includes('entity name')) {
                    map.entity_name = index;
                } else if (normalized.includes('frequency')) {
                    map.frequency = index;
                } else if (normalized.includes('start date')) {
                    map.start_date = index;
                } else if (normalized.includes('end date')) {
                    map.end_date = index;
                } else if (normalized.includes('required')) {
                    map.required = index;
                } else if (normalized.includes('unit')) {
                    map.unit = index;
                } else if (normalized.includes('topic')) {
                    map.topic = index;
                } else if (normalized.includes('notes')) {
                    map.notes = index;
                }
            });

            console.log('[ImportExportModule] Column mapping result:', map);

            return map;
        }

        // Test with actual CSV header
        const csvHeader = 'Field ID,Field Name,Entity ID,Entity Name,Frequency,Start Date,End Date,Required,Unit Override,Topic,Status,Version,Notes';

        console.log('Testing CSV parsing...');
        console.log('Raw header line:', csvHeader);

        const headers = parseCSVLine(csvHeader);
        console.log('Parsed headers:', headers);
        console.log('Headers array length:', headers.length);

        headers.forEach((h, i) => {
            console.log(`Header[${i}]: "${h}" (length: ${h.length})`);
        });

        const columnMap = mapColumns(headers);
        console.log('Final column map:', columnMap);

        // Check if field_id is found
        if (!columnMap.field_id && columnMap.field_id !== 0) {
            console.error('ERROR: field_id column not found!');
            document.getElementById('output').innerHTML = `
                <h2 style="color: red;">BUG REPRODUCED!</h2>
                <p>field_id column was NOT found in column map</p>
                <pre>${JSON.stringify(columnMap, null, 2)}</pre>
            `;
        } else {
            console.log('SUCCESS: field_id column found at index:', columnMap.field_id);
            document.getElementById('output').innerHTML = `
                <h2 style="color: green;">Test Passed</h2>
                <p>field_id column found at index: ${columnMap.field_id}</p>
                <pre>${JSON.stringify(columnMap, null, 2)}</pre>
            `;
        }
    </script>
</body>
</html>
