{% extends "base.html" %}

{% block extra_head %}
    {{ super() }}
    <!-- Dashboard specific CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="data-entry-dashboard">
    <!-- Page Title with Proper Spacing -->
    <div class="page-header">
        <h1 class="page-title">Data Entry Dashboard</h1>
    </div>

    <!-- Action Bar with Improved Layout - Made Sticky -->
    <div class="action-bar sticky-header">
        <div class="container-fluid px-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="date-selection-info">
                        <div id="dateValidationArea" class="validation-area" style="display: none;"></div>
                        <div id="selectedDateInfo" class="selected-date-info" style="display: none;">
                            <small class="text-muted">Selected date: <span id="currentSelectedDate"></span></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="action-buttons-group">
                        <button type="button" id="showValidDatesBtn" class="btn btn-primary">
                            <i class="fas fa-calendar-alt"></i> Select Date
                        </button>
                        <button type="button" id="csvUploadBtn" class="btn btn-outline-primary">
                            <i class="fas fa-upload"></i> Upload CSV
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Date Selection Row -->
            <div class="row mt-3" id="dateSelectionRow" style="display: none;">
                <div class="col-12">
                    <div class="date-chips-container">
                        <div class="date-chips-header">
                            <small class="text-muted">Select a reporting date:</small>
                        </div>
                        <div id="validDatesList" class="date-chips-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Progress Tracker Section - Moved Below Header -->
    <div class="progress-section-compact" id="progressSection" style="display: none;">
        <div class="container-fluid px-3">
            <div class="progress-bar-compact">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="progress-info-compact">
                            <span id="progressText">0 of 0 data points completed</span>
                            <span class="progress-percentage" id="progressPercentage">0%</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" id="progressBar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="completion-indicators" id="completionIndicators">
                            <!-- Progress indicators will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content-area">
        <div class="container-fluid px-3">
            <!-- Form Blocker -->
            <div id="formBlocker" class="form-blocker" style="display: none;">
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle"></i> Select a Valid Date</h5>
                    <p>Please select a valid reporting date to view and submit data.</p>
                </div>
            </div>

            <!-- Data Entry Form -->
            {% if raw_input_points or computed_points %}
                <form method="POST" action="{{ url_for('user.submit_data') }}" id="dataEntryForm">
                    <input type="hidden" name="reporting_date" id="formReportingDate" value="{{ selected_date.strftime('%Y-%m-%d') }}">
                    
                    <div id="dataTableContainer" class="data-table-container">
                        <div class="table-responsive">
                            <table class="table table-hover data-table" id="dataPointsTable">
                                <thead class="table-header-enhanced">
                                    <tr>
                                        <th class="fw-bold text-white">DATA POINT</th>
                                        <th class="fw-bold text-white">ENTITY</th>
                                        <th class="fw-bold text-white">TYPE</th>
                                        <th class="fw-bold text-white">FREQUENCY</th>
                                        <th class="fw-bold text-white">VALUE</th>
                                        <th class="fw-bold text-white">ATTACHMENTS</th>
                                    </tr>
                                </thead>
                                <tbody id="dataPointsTableBody">
                                    <!-- Data points will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-actions sticky-bottom">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-save"></i> Save Data
                            </button>
                        </div>
                    </div>
                </form>
            {% else %}
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> No Data Points Assigned</h5>
                    <p>You don't have any data points assigned to your entity.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Enhanced CSV Upload Modal -->
<div class="modal fade" id="csvUploadModal" tabindex="-1" aria-labelledby="csvUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="csvUploadModalLabel">
                    <i class="fas fa-upload"></i> Upload CSV Data
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="upload-section">
                            <h6 class="section-title">Upload CSV File</h6>
                            <form id="csvUploadForm" enctype="multipart/form-data">
                                <input type="hidden" id="csvReportingDate" name="reporting_date">
                                <div class="mb-3">
                                    <label for="csvFileInput" class="form-label">Choose CSV file</label>
                                    <input type="file" class="form-control" id="csvFileInput" name="csv_file" accept=".csv" required>
                                    <div class="form-text">Upload a CSV file with your data entries.</div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-upload"></i> Upload & Process
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="downloadTemplateFromModal">
                                        <i class="fas fa-download"></i> Download Template
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="instructions-section">
                            <h6 class="section-title">Quick Instructions</h6>
                            <div class="alert alert-info small mb-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Tip:</strong> Download the template above for the correct format with data points due for your selected date.
                            </div>
                            <div class="alert alert-success small mb-3">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Excel Users:</strong> The template is designed to preserve date formatting (YYYY-MM-DD) when opened in Excel.
                            </div>
                            <div class="requirements-list">
                                <h6 class="small fw-bold text-muted mb-2">CSV FORMAT:</h6>
                                <ul class="list-unstyled small text-muted">
                                    <li><i class="fas fa-check text-success me-2"></i><strong>Reporting Date:</strong> YYYY-MM-DD format</li>
                                    <li><i class="fas fa-check text-success me-2"></i><strong>Data Point Name:</strong> Exact name of the data point</li>
                                    <li><i class="fas fa-check text-success me-2"></i><strong>Frequency:</strong> Optional - Data point frequency (Annual, Quarterly, etc.)</li>
                                    <li><i class="fas fa-check text-success me-2"></i><strong>Value:</strong> Numeric or text value</li>
                                </ul>
                                <div class="alert alert-warning small mt-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Multiple Dates:</strong> You can include data for multiple dates in one file. Each row will be validated against its date's assignment rules.
                                </div>
                                <div class="alert alert-secondary small mt-2">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    <strong>Frequency Column:</strong> The frequency column is optional and informational. If provided, mismatches will generate warnings but won't prevent data upload.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="csvUploadResults" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- File upload modal (for individual attachments) -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" id="dataIdInput" name="data_id">
                    <input type="hidden" id="statusInput" name="status">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Choose file</label>
                        <input type="file" class="form-control" id="fileInput" name="file">
                    </div>
                </form>
                <div id="currentAttachments">
                    <!-- Current attachments will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="uploadButton">Upload</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block afterbody %}
    {{ super() }}
    
    <!-- Data for JavaScript - Properly escaped JSON -->
    <script type="application/json" id="dataPointsData">
        {{ {
            'rawInputPoints': raw_input_points,
            'computedPoints': computed_points,
            'rawDependencies': raw_dependencies,
            'entityDataEntries': entity_data_entries,
            'esgDataByDate': esg_data_by_date,
            'selectedDate': selected_date.strftime('%Y-%m-%d')
        } | tojson | safe }}
    </script>
    
    <!-- Load PopupManager first -->
    <script src="{{ url_for('static', filename='js/common/popup.js') }}"></script>
    
    <!-- Load other scripts -->
    <script src="{{ url_for('static', filename='js/user/user_dashboard_dates.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user/computed_fields.js') }}"></script>
    
    <!-- Dashboard Initialization -->
    <script>
        // Dashboard initialization class for better organization
        class DashboardInitializer {
            constructor() {
                this.isInitialized = false;
                this.dataConfig = null;
            }
            
            async init() {
                if (this.isInitialized) {
                    console.warn('Dashboard already initialized');
                    return;
                }
                
                try {
                    // Load configuration data
                    this.loadConfigurationData();
                    
                    // Initialize PopupManager
                    if (window.PopupManager) {
                        window.PopupManager.init();
                        console.log('✅ PopupManager initialized');
                    }
                    
                    this.isInitialized = true;
                    console.log('✅ Dashboard initialization completed successfully');
                    
                    // Dispatch initialization complete event
                    document.dispatchEvent(new CustomEvent('dashboardInitialized', {
                        detail: { config: this.dataConfig }
                    }));
                    
                } catch (error) {
                    console.error('❌ Dashboard initialization failed:', error);
                    this.showInitializationError(error);
                }
            }
            
            loadConfigurationData() {
                const dataScript = document.getElementById('dataPointsData');
                if (!dataScript) {
                    throw new Error('Configuration data not found');
                }
                
                try {
                    this.dataConfig = JSON.parse(dataScript.textContent);
                    console.log('📊 Configuration data loaded:', Object.keys(this.dataConfig));
                    
                    // Make configuration globally available
                    window.dashboardConfig = this.dataConfig;
                } catch (error) {
                    throw new Error('Failed to parse configuration data: ' + error.message);
                }
            }
            
            showInitializationError(error) {
                const errorContainer = document.createElement('div');
                errorContainer.className = 'alert alert-danger position-fixed';
                errorContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
                errorContainer.innerHTML = `
                    <h6><i class="fas fa-exclamation-triangle"></i> Dashboard Error</h6>
                    <p>Failed to initialize dashboard: ${error.message}</p>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> Reload Page
                    </button>
                `;
                document.body.appendChild(errorContainer);
                
                // Auto-remove after 10 seconds
                setTimeout(() => errorContainer.remove(), 10000);
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const initializer = new DashboardInitializer();
            initializer.init();
        });
    </script>
    
    <!-- Component Initialization -->
    <script>
        // Component initialization with proper error handling
        document.addEventListener('dashboardInitialized', function(event) {
            try {
                const config = event.detail.config;
                
                // Debug: Log the configuration data
                console.log('🔍 Dashboard configuration received:', config);
                console.log('🧮 Computed points in config:', config.computedPoints);
                console.log('📊 Raw input points in config:', config.rawInputPoints);
                console.log('🔗 Raw dependencies in config:', config.rawDependencies);
                
                // Debug: Check if scripts are loaded
                console.log('🔍 Script loading check:');
                console.log('  - EnhancedDateValidator:', typeof EnhancedDateValidator);
                console.log('  - ComputedFieldsManager:', typeof ComputedFieldsManager);
                console.log('  - window.computedFieldsManager:', typeof window.computedFieldsManager);
                
                // Initialize ComputedFieldsManager FIRST (it should already be initialized by the script)
                if (typeof ComputedFieldsManager !== 'undefined' && !window.computedFieldsManager) {
                    window.computedFieldsManager = new ComputedFieldsManager();
                    console.log('✅ ComputedFieldsManager initialized manually');
                } else if (window.computedFieldsManager) {
                    console.log('✅ ComputedFieldsManager already available');
                } else {
                    console.error('❌ ComputedFieldsManager class not found');
                }
                
                // Initialize EnhancedDateValidator AFTER ComputedFieldsManager
                if (typeof EnhancedDateValidator !== 'undefined' && !window.dashboard) {
                    window.dashboard = new EnhancedDateValidator();
                    console.log('✅ EnhancedDateValidator initialized manually');
                } else if (window.dashboard) {
                    console.log('✅ EnhancedDateValidator already available');
                } else {
                    console.error('❌ EnhancedDateValidator class not found');
                }
                
                // Set up form event listeners
                setupFormEventListeners();
                
                console.log('✅ All components initialized successfully');
                
            } catch (error) {
                console.error('❌ Component initialization failed:', error);
            }
        });
        
        function setupFormEventListeners() {
            // Date selector changes
            const dateInput = document.getElementById('dateSelector');
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    const newDate = this.value;
                    if (newDate) {
                        document.dispatchEvent(new CustomEvent('dateChanged', {
                            detail: { date: newDate }
                        }));
                        
                        if (window.computedFieldsManager && window.computedFieldsManager.clearCache) {
                            window.computedFieldsManager.clearCache();
                        }
                    }
                });
            }
            
            // Form submission cache clearing
            const dataForm = document.getElementById('dataEntryForm');
            if (dataForm) {
                dataForm.addEventListener('submit', function() {
                    setTimeout(() => {
                        if (window.computedFieldsManager && window.computedFieldsManager.clearCache) {
                            window.computedFieldsManager.clearCache();
                        }
                    }, 1000);
                });
            }
        }
        
        // Global error handler for unhandled JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            
            // Show user-friendly error message for critical errors
            if (event.error && event.error.message && event.error.message.includes('dashboard')) {
                if (window.PopupManager && window.PopupManager.showError) {
                    window.PopupManager.showError(
                        'Dashboard Error',
                        'A dashboard component encountered an error. Please refresh the page if issues persist.'
                    );
                }
            }
        });
    </script>
{% endblock %} 