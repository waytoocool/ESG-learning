{% extends "base.html" %}

{% block content %}
<div class="assign-data-points-redesigned" role="main" aria-label="ESG Data Points Management Interface">
    <!-- Main toolbar -->
    <header class="toolbar" role="banner" aria-label="Page header and actions">
        <div class="toolbar-center">
            <div class="selected-count-indicator" role="status" aria-live="polite" aria-label="Selection counter">
                <span id="selectedCount">0</span> data points selected
            </div>
        </div>
        <nav class="toolbar-right" role="navigation" aria-label="Data points actions">
            <button id="configureSelected" class="btn btn-primary" disabled aria-describedby="configure-help">
                <i class="fas fa-cog" aria-hidden="true"></i> Configure Selected
            </button>
            <button id="assignEntities" class="btn btn-primary" disabled aria-describedby="assign-help">
                üè¢ Assign Entities
            </button>
            <button id="saveAllConfiguration" class="btn btn-success" disabled aria-describedby="save-help">
                <i class="fas fa-save" aria-hidden="true"></i> Save All
            </button>
            <button id="exportAssignments" class="btn btn-outline-primary" aria-describedby="export-help" title="Export assignments to CSV/Excel">
                <i class="fas fa-download" aria-hidden="true"></i> Export
            </button>
            <button id="importAssignments" class="btn btn-outline-primary" aria-describedby="import-help" title="Import assignments from CSV/Excel">
                <i class="fas fa-upload" aria-hidden="true"></i> Import
            </button>
        </nav>
    </header>

    <!-- Simple Side-by-Side Layout -->
    <div class="main-layout">
        <!-- Left Panel -->
        <div class="selection-panel">
            <header class="panel-header">
                <h2 id="selection-heading"><i class="fas fa-chart-bar" aria-hidden="true"></i> Select Data Points</h2>
            </header>
            
            <!-- Integrated Search & Filter Bar -->
            <div class="search-filter-bar" role="search" aria-label="Search and filter controls">
                <div class="search-input-wrapper">
                    <label for="dataPointSearch" class="sr-only">Search data points</label>
                    <input type="search" 
                           id="dataPointSearch" 
                           class="form-control" 
                           placeholder="Search data points across all frameworks..."
                           aria-label="Search data points across all frameworks"
                           autocomplete="off">
                    <i class="fas fa-search search-icon" aria-hidden="true"></i>
                </div>
                <div class="filter-controls">
                    <label for="framework_select" class="sr-only">Filter by framework</label>
                    <select id="framework_select" class="form-select filter-select" aria-label="Filter by framework">
                        <option value="">All Frameworks</option>
                        {% for framework in frameworks %}
                            <option value="{{ framework.framework_id }}">{{ framework.framework_name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" 
                            id="clearFilters" 
                            class="btn btn-outline-secondary btn-sm" 
                            title="Clear all filters"
                            aria-label="Clear all search and filter criteria">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <!-- View Toggle Controls -->
            <nav class="content-switcher" role="tablist" aria-label="Data view options">
                <div class="view-toggle-buttons">
                    <button id="topicTreeViewBtn" 
                            class="view-toggle-btn active" 
                            role="tab" 
                            aria-selected="true"
                            aria-controls="topicTreeView"
                            aria-label="Topic hierarchy view">
                        <i class="fas fa-sitemap" aria-hidden="true"></i> Topics
                    </button>
                    <button id="flatListViewBtn"
                            class="view-toggle-btn"
                            role="tab"
                            aria-selected="false"
                            aria-controls="flatListView"
                            aria-label="All fields list view">
                        <i class="fas fa-list" aria-hidden="true"></i> All Fields
                    </button>
                </div>
            </nav>

            <!-- Search Results View (shown when searching) -->
            <div id="searchResultsView" class="search-results-container" style="display: none;">
                <div class="search-results-header">
                    <span id="searchResultsTitle">Search Results</span>
                    <button id="clearSearch" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear Search
                    </button>
                </div>
                <div id="searchResults" class="search-results-list">
                    <!-- Search results will be populated here -->
                </div>
            </div>

            <!-- Topic Tree View -->
            <div id="topicTreeView" class="topics-container">
                <div class="topics-header">
                    <span>Topic Hierarchy</span>
                    <div class="topic-actions">
                        <button id="expandAllTopics" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-plus-square"></i> Expand All
                        </button>
                        <button id="collapseAllTopics" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-minus-square"></i> Collapse All
                        </button>
                    </div>
                </div>
                <div id="topicTree" class="topic-tree">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading topic hierarchy...</p>
                    </div>
                </div>
            </div>

            <!-- Flat List View (original) -->
            <div id="flatListView" class="available-points-container" style="display: none;">
                <div class="available-points-header">
                    <span>Available Data Points</span>
                    <button id="selectAllVisible" class="btn btn-sm btn-outline-primary">Add All</button>
                </div>
                <div id="availableFields" class="available-points-list">
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>Loading data points...</p>
                        <small>Use search and filters to find specific data points</small>
                    </div>
                </div>
            </div>

        </div>
        
        <!-- Right Panel -->
        <div class="selected-panel">
            <header class="panel-header">
                <h2 id="selected-heading"><i class="fas fa-list-check" aria-hidden="true"></i> Selected Data Points</h2>
                <nav class="bulk-selection-controls" role="navigation" aria-label="Bulk selection controls">
                    <button id="selectAllDataPoints"
                            class="btn btn-sm btn-outline-primary"
                            aria-label="Select all data points in list">Select All</button>
                    <button id="deselectAllDataPoints"
                            class="btn btn-sm btn-outline-secondary"
                            aria-label="Deselect all data points in list">Deselect All</button>
                    <button id="toggleInactiveAssignments"
                            class="btn btn-sm btn-link text-muted"
                            aria-label="Toggle visibility of inactive assignments"
                            title="Show/Hide previously deleted assignments">
                        <i class="fas fa-eye-slash" aria-hidden="true"></i> Show Inactive
                    </button>
                </nav>
            </header>

            <!-- Selected Data Points List with Checkboxes and Status -->
            <div id="selectedDataPointsList" 
                 class="selected-points-list" 
                 role="region"
                 aria-live="polite"
                 aria-label="Selected data points list">
                <div class="empty-state" role="status">
                    <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                    <p>No data points selected yet</p>
                    <small>Add data points from the left panel to configure them</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden help text for screen readers -->
    <div class="sr-only">
        <div id="configure-help">Configure settings for selected data points including frequency and validation rules</div>
        <div id="assign-help">Assign selected data points to specific entities in your organization</div>
        <div id="save-help">Save all configuration changes and assignments</div>
        <div id="export-help">Export current assignments to CSV or Excel format for external use</div>
        <div id="import-help">Import assignments from CSV or Excel file to bulk configure data points</div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configurationModal" tabindex="-1" aria-labelledby="configurationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content config-modal-redesigned">
            <!-- Modal Header -->
            <div class="config-modal-header">
                <h2 class="config-modal-title" id="configurationModalLabel">Configure Data Points</h2>
                <button type="button" class="config-modal-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="config-modal-body">
                <!-- Info Banner -->
                <div class="config-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <p>You are configuring <span id="configPointCount">1</span> data point(s).</p>
                    <div id="configChangeSummary" class="config-change-summary" style="display: none;">
                        <small><strong>Only modified fields will be applied.</strong> Unchanged fields will preserve their current values.</small>
                    </div>
                </div>

                <!-- Data Collection Frequency Section -->
                <div class="config-section">
                    <h3 class="config-section-title">Data Collection Frequency</h3>
                    <div class="config-form-group">
                        <label for="modalFrequency" class="config-label">Frequency</label>
                        <select id="modalFrequency" class="config-select">
                            <option value="Annual" selected>Annual</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                        <p class="config-help-text">Frequency determines how often data should be collected for these assignments.</p>
                    </div>
                </div>

                <!-- Divider -->
                <div class="config-divider"></div>

                <!-- Unit Override Section -->
                <div class="config-section">
                    <div class="config-section-header">
                        <h3 class="config-section-title">Unit Override</h3>
                        <div class="config-toggle">
                            <input type="checkbox" id="unitOverrideToggle" class="config-toggle-checkbox">
                            <label for="unitOverrideToggle" class="config-toggle-label"></label>
                        </div>
                    </div>
                    <p class="config-section-description">Override default units for selected data points.</p>

                    <div class="config-form-group">
                        <label for="modalUnitOverrideSelect" class="config-label">Override Unit</label>
                        <select id="modalUnitOverrideSelect" class="config-select">
                            <option value="">Use default unit for each field</option>
                            <option value="kg">kg</option>
                            <option value="tonnes">Tonnes</option>
                            <option value="tons">Tons</option>
                            <option value="m¬≥">m¬≥</option>
                            <option value="liters">Liters</option>
                            <option value="kWh">kWh</option>
                            <option value="MWh">MWh</option>
                            <option value="GJ">GJ</option>
                            <option value="%">%</option>
                            <option value="count">Count</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                            <option value="$">$</option>
                        </select>
                        <p class="config-help-text">This will override the default unit for all selected data points. Leave empty to use each field's default unit.</p>
                    </div>
                </div>

                <!-- Divider -->
                <div class="config-divider"></div>

                <!-- Material Topic Assignment Section -->
                <div class="config-section">
                    <div class="config-section-header">
                        <h3 class="config-section-title">Material Topic Assignment</h3>
                        <div class="config-toggle">
                            <input type="checkbox" id="materialTopicToggle" class="config-toggle-checkbox" checked>
                            <label for="materialTopicToggle" class="config-toggle-label"></label>
                        </div>
                    </div>
                    <p class="config-section-description">Ready to assign material topics to selected data points.</p>

                    <div class="config-form-group">
                        <div class="config-form-row">
                            <label for="modalTopicSelect" class="config-label">Assign Material Topic</label>
                            <button type="button" id="clearTopicAssignment" class="config-clear-btn">
                                <i class="fas fa-times"></i> CLEAR ASSIGNMENT
                            </button>
                        </div>
                        <select id="modalTopicSelect" class="config-select">
                            <option value="">Select a material topic...</option>
                            <option value="framework_topic" disabled>‚îÄ‚îÄ Framework Topics ‚îÄ‚îÄ</option>
                            <!-- Options populated by JavaScript -->
                        </select>
                        <p class="config-help-text">Material topics help organize data points for materiality assessment and reporting.</p>
                    </div>
                </div>

                <!-- Divider -->
                <div class="config-divider"></div>

                <!-- Data Collection Settings Section -->
                <div class="config-section">
                    <div class="config-section-header">
                        <h3 class="config-section-title">Data Collection Settings</h3>
                        <span class="config-coming-soon-badge">Coming Soon</span>
                    </div>
                    <p class="config-section-description config-coming-soon-note">Advanced data collection features are in development and will be available in a future update.</p>

                    <div class="config-grid-3 config-disabled-section">
                        <div class="config-form-group">
                            <label for="modalCollectionMethod" class="config-label">Collection Method</label>
                            <select id="modalCollectionMethod" class="config-select" disabled>
                                <option value="Manual Entry" selected>Manual Entry</option>
                                <option value="File Upload">File Upload</option>
                                <option value="API Integration">API Integration</option>
                            </select>
                        </div>
                        <div class="config-form-group">
                            <label for="modalValidationRules" class="config-label">Validation Rules</label>
                            <select id="modalValidationRules" class="config-select" disabled>
                                <option value="Required" selected>Required</option>
                                <option value="Optional">Optional</option>
                                <option value="Conditional">Conditional</option>
                            </select>
                        </div>
                        <div class="config-form-group">
                            <label for="modalApprovalRequired" class="config-label">Approval Required</label>
                            <select id="modalApprovalRequired" class="config-select" disabled>
                                <option value="No" selected>No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="config-modal-footer">
                <button type="button" class="config-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="applyConfiguration" class="config-btn-primary">
                    <i class="fas fa-check-circle"></i>
                    <span>Apply Configuration</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Entity Assignment Modal -->
<!-- Entity Assignment Modal -->
<div class="modal fade" id="entityModal" tabindex="-1" aria-labelledby="entityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content config-modal-redesigned">
            <!-- Modal Header -->
            <div class="config-modal-header">
                <h2 class="config-modal-title" id="entityModalLabel">Assign Entities</h2>
                <button type="button" class="config-modal-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="config-modal-body">
                <!-- Info Banner -->
                <div class="config-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <p>Assigning entities to <span id="entityPointCount">1</span> data point(s) with inherited configuration.</p>
                </div>

                <!-- Entity Assignment Section -->
                <div class="config-section">
                    <h3 class="config-section-title">Available Entities</h3>
                    <p class="config-section-description">Select entities that should collect data for the assigned data points.</p>

                    <div class="entity-assignment-layout">
                        <!-- Left Column: Available Entities -->
                        <div class="entity-column">
                            <div class="entity-column-header">
                                <i class="fas fa-building"></i>
                                <span>Available Entities</span>
                            </div>
                            <div id="modalAvailableEntities" class="entity-list">
                                <!-- Available entities will be loaded here -->
                            </div>
                        </div>

                        <!-- Right Column: Company Hierarchy (will be populated by JavaScript) -->
                        <div class="entity-column">
                            <div class="entity-column-header">
                                <i class="fas fa-sitemap"></i>
                                <span>Company Hierarchy</span>
                            </div>
                            <div id="entityHierarchyContainer" class="entity-hierarchy">
                                <!-- Entity hierarchy will be loaded here by JavaScript -->
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading entity hierarchy...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Entities Summary -->
                    <div class="config-divider"></div>
                    <div class="selected-entities-section">
                        <div class="config-section-header">
                            <h4 class="config-section-title">Selected Entities (<span id="modalSelectedEntitiesCount">1</span>)</h4>
                        </div>
                        <div id="modalSelectedEntities" class="selected-entities-list">
                            <!-- Selected entities will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="config-modal-footer">
                <button type="button" class="config-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="applyEntityAssignment" class="config-btn-primary">
                    <i class="fas fa-check"></i>
                    Assign Entities
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Field Info Modal -->
<div class="modal fade field-info-modal" id="fieldInfoModal" tabindex="-1" aria-labelledby="fieldInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldInfoModalLabel">
                    <i class="fas fa-info-circle"></i> Field Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs" id="fieldInfoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="field-details-tab" data-bs-toggle="tab" data-bs-target="#field-details" type="button" role="tab" aria-controls="field-details" aria-selected="true">
                            <i class="fas fa-info-circle"></i> Field Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="assignment-history-tab" data-bs-toggle="tab" data-bs-target="#assignment-history" type="button" role="tab" aria-controls="assignment-history" aria-selected="false">
                            <i class="fas fa-history"></i> Assignment History
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="fieldInfoTabContent">
                    <!-- Field Details Tab -->
                    <div class="tab-pane fade show active" id="field-details" role="tabpanel" aria-labelledby="field-details-tab">
                        <div class="field-info-content">
                            <!-- Field Basic Information -->
                            <div class="field-info-grid">
                                <div class="field-info-row">
                                    <div class="field-info-group">
                                        <label class="field-info-label">Field Name</label>
                                        <span class="field-info-value" id="fieldInfoName">-</span>
                                    </div>
                                    <div class="field-info-group">
                                        <label class="field-info-label">Data Type</label>
                                        <span class="field-info-value" id="fieldInfoType">-</span>
                                    </div>
                                </div>

                                <div class="field-info-row">
                                    <div class="field-info-group">
                                        <label class="field-info-label">Topic</label>
                                        <span class="field-info-value" id="fieldInfoTopic">-</span>
                                    </div>
                                    <div class="field-info-group">
                                        <label class="field-info-label">Framework</label>
                                        <span class="field-info-value" id="fieldInfoFramework">-</span>
                                    </div>
                                </div>

                                <div class="field-info-row">
                                    <div class="field-info-group">
                                        <label class="field-info-label">Unit Category</label>
                                        <span class="field-info-value" id="fieldInfoUnitCategory">-</span>
                                    </div>
                                    <div class="field-info-group">
                                        <label class="field-info-label">Default Unit</label>
                                        <span class="field-info-value" id="fieldInfoDefaultUnit">-</span>
                                    </div>
                                </div>

                                <div class="field-info-row">
                                    <div class="field-info-group">
                                        <label class="field-info-label">Field Code</label>
                                        <span class="field-info-value" id="fieldInfoCode">-</span>
                                    </div>
                                    <div class="field-info-group">
                                        <label class="field-info-label">Frequency</label>
                                        <span class="field-info-value" id="fieldInfoFrequency">-</span>
                                    </div>
                                </div>

                                <div class="field-info-row">
                                    <div class="field-info-group">
                                        <label class="field-info-label">Status</label>
                                        <span class="field-info-value field-status" id="fieldInfoStatus">-</span>
                                    </div>
                                    <div class="field-info-group">
                                        <label class="field-info-label">Field ID</label>
                                        <span class="field-info-value field-id" id="fieldInfoFieldId">-</span>
                                    </div>
                                </div>
                            </div>

                <!-- Computed Field Indicator -->
                <div class="alert alert-info" id="fieldInfoComputedIndicator" style="display: none;">
                    <!-- Content populated by JavaScript -->
                </div>

                <!-- Field Description (if available) -->
                <div class="field-info-description" id="fieldInfoDescription" style="display: none;">
                    <h6><i class="fas fa-file-text"></i> Description</h6>
                    <p id="fieldInfoDescriptionText">-</p>
                </div>

                <!-- Enhanced Computed Field Details -->
                <div class="computed-field-details" id="fieldInfoComputedDetails" style="display: none;">
                    <h6><i class="fas fa-calculator"></i> Computed Field Details</h6>
                    
                    <!-- Calculation Formula -->
                    <div class="field-formula-section" style="display: none;">
                        <label class="form-label"><i class="fas fa-function"></i> Calculation Formula:</label>
                        <div class="formula-display">
                            <code id="fieldInfoFormula">-</code>
                        </div>
                    </div>
                    
                    <!-- Dependencies List -->
                    <div class="dependencies-list-section mt-3">
                        <label class="form-label"><i class="fas fa-sitemap"></i> Dependencies:</label>
                        <div class="dependencies-list" id="fieldInfoDependencies">
                            <!-- Dependencies populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Dependency Tree Information -->
                    <div class="dependency-tree-info mt-2">
                        <small class="text-muted" id="fieldInfoTreeInfo">-</small>
                    </div>
                </div>

                <!-- Configuration Conflicts Warning -->
                <div class="conflicts-section" id="fieldInfoConflicts" style="display: none;">
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> Configuration Conflicts</h6>
                    <div id="fieldInfoConflictList">
                        <!-- Conflicts populated by JavaScript -->
                    </div>
                </div>
                        </div>
                    </div>
                    
                    <!-- Assignment History Tab -->
                    <div class="tab-pane fade" id="assignment-history" role="tabpanel" aria-labelledby="assignment-history-tab">
                        <div class="field-info-content">
                            <div class="assignment-history-header">
                                <h6>
                                    <i class="fas fa-history"></i> Assignment History for <span id="historyFieldName">-</span>
                                </h6>
                                <button type="button" class="config-btn-secondary btn-sm" id="refreshHistory">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="historyLoading" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading history...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading assignment history...</p>
                            </div>
                            
                            <!-- History Content -->
                            <div id="historyContent" style="display: none;">
                                <!-- Summary Cards -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-primary" id="historyTotalCount">0</h5>
                                                <p class="card-text">Total Assignments</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-success" id="historyActiveCount">0</h5>
                                                <p class="card-text">Active Assignments</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-warning" id="historySupersededCount">0</h5>
                                                <p class="card-text">Superseded</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- History Timeline -->
                                <div class="assignment-history-timeline" id="historyTimeline">
                                    <!-- Timeline will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="historyEmpty" class="text-center py-4" style="display: none;">
                                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No assignment history found for this field.</p>
                                <small class="text-muted">Assignment history will appear here once this field has been assigned to entities.</small>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Templates for dynamic content -->
<template id="dataPointCardTemplate">
    <div class="data-point-card" data-field-id="">
        <div class="card-content">
            <div class="point-info">
                <h5 class="point-name"></h5>
                <div class="point-meta">
                    <span class="badge badge-type"></span>
                    <span class="badge badge-unit"></span>
                    <span class="badge badge-computed" style="display: none;">Computed</span>
                </div>
                <div class="point-details">
                    <small class="field-code"></small>
                    <small class="unit-category"></small>
                </div>
            </div>
            <div class="card-actions">
                <button class="btn btn-sm btn-primary add-point">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<template id="selectedPointTemplate">
    <div class="selected-point-item" data-field-id="">
        <div class="point-checkbox">
            <input type="checkbox" class="point-select">
        </div>
        <div class="point-content">
            <div class="point-main-info">
                <div class="point-header">
                    <h5 class="point-name"></h5>
                </div>
            </div>
            <div class="point-status-indicators">
                <div class="status-item">
                    <div class="status-icon config-status">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="status-text">
                        <span class="status-label">Config:</span>
                        <span class="status-value config-value">Not configured</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon entity-status">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="status-text">
                        <span class="status-label">Entities:</span>
                        <span class="status-value entity-value">No entities assigned</span>
                    </div>
                </div>
            </div>
            
            <!-- Dependencies Section for Computed Fields -->
            <div class="dependencies-section" style="display: none;">
                <div class="dependencies-header">
                    <div class="dependencies-toggle">
                        <i class="fas fa-chevron-right toggle-icon"></i>
                        <span class="dependencies-title">Dependencies (<span class="dep-count">0</span>)</span>
                    </div>
                    <div class="dependencies-info">
                        <i class="fas fa-info-circle" title="Auto-added dependencies inherit configuration"></i>
                    </div>
                </div>
                <div class="dependencies-list" style="display: none;">
                    <!-- Dependency items will be added here -->
                </div>
            </div>
            <div class="point-actions">
                <button type="button" class="action-btn info field-info-single" data-field-id="" title="View field information">
                    <i class="fas fa-info-circle"></i> Info
                </button>
                <button type="button" class="action-btn configure-single" data-field-id="" title="Configure this data point">
                    <i class="fas fa-cog"></i> Config
                </button>
                <button type="button" class="action-btn secondary assign-single" data-field-id="" title="Assign entities to this data point">
                    <i class="fas fa-building"></i> Entities
                </button>
                <button type="button" class="remove-point" data-field-id="" title="Remove from selection">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<template id="entityItemTemplate">
    <div class="entity-item" data-entity-id="">
        <div class="entity-icon"></div>
        <div class="entity-name"></div>
        <div class="entity-actions">
            <button class="btn btn-sm btn-outline-primary move-entity">
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
</template>

<!-- Topic Tree Templates -->
<template id="topicNodeTemplate">
    <div class="topic-node" data-topic-id="" data-level="">
        <div class="topic-header">
            <div class="topic-toggle">
                <i class="fas fa-chevron-right toggle-icon"></i>
            </div>
            <div class="topic-info">
                <span class="topic-name"></span>
                <span class="topic-meta">
                    <span class="framework-badge"></span>
                </span>
            </div>
            <div class="topic-actions">
                <button class="select-all-topic btn btn-sm btn-outline-primary" title="Add all fields in this topic">
                    <i class="fas fa-plus-circle"></i> Add All
                </button>
            </div>
        </div>
        <div class="topic-children" style="display: none;">
            <!-- Child topics and data points will be inserted here -->
        </div>
    </div>
</template>

<template id="topicDataPointTemplate">
    <div class="topic-data-point" data-field-id="">
        <div class="field-info">
            <div class="field-details">
                <div class="field-display">
                    <div class="field-first-line">
                        <span class="field-name"></span>
                    </div>
                    <div class="field-second-line">
                        <span class="field-code"></span>
                        <span class="field-description"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="field-actions">
            <button class="add-field-btn btn btn-sm btn-primary" title="Add this field">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
</template>

<!-- Search Result Templates -->
<template id="searchResultItemTemplate">
    <div class="search-result-item" data-field-id="">
        <div class="search-result-content">
            <div class="field-main-info">
                <div class="field-name-section">
                    <span class="search-field-name"></span>
                    <div class="field-badges">
                        <span class="badge badge-type"></span>
                        <span class="badge badge-unit"></span>
                        <span class="badge badge-computed" style="display: none;">
                            <i class="fas fa-calculator"></i> Computed
                        </span>
                    </div>
                </div>
                <div class="search-breadcrumb">
                    <i class="fas fa-sitemap"></i>
                    <span class="breadcrumb-path"></span>
                </div>
                <div class="field-description" style="display: none;">
                    <small class="description-text"></small>
                </div>
            </div>
            <div class="search-result-actions">
                <button class="add-search-result btn btn-sm btn-primary" title="Add this field">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Dependency Item Template -->
<template id="dependencyItemTemplate">
    <div class="dependency-item" data-field-id="">
        <div class="dependency-content">
            <div class="dependency-indicator">
                <i class="fas fa-link dependency-icon"></i>
            </div>
            <div class="dependency-info">
                <span class="dependency-name"></span>
                <div class="dependency-meta">
                    <span class="dependency-status auto-added">Auto-added</span>
                    <span class="dependency-conflict" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> Conflict
                    </span>
                </div>
            </div>
            <div class="dependency-actions">
                <button class="dependency-info-btn btn btn-sm btn-outline-secondary" title="View dependency info">
                    <i class="fas fa-info"></i>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/assign_data_points_redesigned.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/assign_data_points/modals_redesigned.css') }}">
{% endblock %}

<!-- Import Validation Modal Template -->
<div id="importValidationModal" class="import-validation-modal-overlay" style="display: none;">
    <div class="import-validation-modal">
        <div class="validation-header">
            <div class="validation-status">
                <span class="status-icon"></span>
                <h3 class="status-text"></h3>
            </div>
            <button class="close-button" id="cancelImport">&times;</button>
        </div>

        <div class="validation-body">
            <div class="validation-summary">
                <h4>üìä Import Summary</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Total Records:</span>
                        <span class="value" id="totalRecords">0</span>
                    </div>
                    <div class="summary-item valid">
                        <span class="label">‚úÖ Valid:</span>
                        <span class="value" id="validCount">0</span>
                    </div>
                    <div class="summary-item warning">
                        <span class="label">‚ö†Ô∏è Warnings:</span>
                        <span class="value" id="warningCount">0</span>
                    </div>
                    <div class="summary-item error">
                        <span class="label">‚ùå Errors:</span>
                        <span class="value" id="errorCount">0</span>
                    </div>
                </div>
            </div>

            <div class="validation-preview">
                <h4>üìã Import Preview</h4>
                <p class="preview-count" id="previewCount">No records to import</p>
                <div class="preview-list" id="previewList">
                    <!-- Preview items will be populated here -->
                </div>
            </div>

            <div class="validation-details" id="validationDetails">
                <!-- Detailed validation results will be populated here -->
            </div>
        </div>

        <div class="validation-actions">
            <button class="btn-cancel" id="cancelImportBtn">Cancel Import</button>
            <button class="btn-confirm" id="confirmImport">Proceed with Import</button>
        </div>
    </div>
</div>

<!-- Import Results Modal Template -->
<div id="importResultsModal" class="import-results-modal-overlay" style="display: none;">
    <div class="import-results-modal">
        <div class="results-header">
            <h3 id="resultsTitle">Import Results</h3>
            <button class="close-button" id="closeResults">&times;</button>
        </div>
        <div class="results-body" id="resultsBody">
            <!-- Results content will be populated here -->
        </div>
        <div class="results-actions">
            <button class="btn-primary" id="closeResultsBtn">Close</button>
        </div>
    </div>
</div>


{% block afterbody %}
<script type="module">
    import { PopupManager } from "{{ url_for('static', filename='js/common/popup.js') }}";
    window.PopupManager = PopupManager;
</script>
<script src="{{ url_for('static', filename='js/admin/assign_data_point_ConfirmationDialog.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/assign_data_points_import.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/assign_data_points_redesigned.js') }}"></script>

<!-- Phase 7: Versioning Module for assignment versioning and lifecycle management -->
<script src="{{ url_for('static', filename='js/admin/assign_data_points/VersioningModule.js') }}"></script>

<!-- Phase 8: History & Import/Export Modules for bulk operations and history tracking -->
<script src="{{ url_for('static', filename='js/admin/assign_data_points/HistoryModule.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/assign_data_points/ImportExportModule.js') }}"></script>

<!-- Initialize Phase 7 & 8 Modules -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[INIT] Initializing Phase 7 & 8 modules...');

    // Initialize Versioning Module (Phase 7)
    if (typeof window.VersioningModule !== 'undefined') {
        try {
            if (typeof window.DataPointsManager !== 'undefined' && window.DataPointsManager) {
                window.DataPointsManager.versioningModule = new window.VersioningModule(window.DataPointsManager);
                console.log('[INIT] ‚úÖ VersioningModule initialized and attached to DataPointsManager');
            } else {
                console.warn('[INIT] ‚ö†Ô∏è VersioningModule loaded but DataPointsManager not ready');
            }
        } catch (error) {
            console.error('[INIT] ‚ùå Failed to initialize VersioningModule:', error);
        }
    } else {
        console.error('[INIT] ‚ùå VersioningModule not loaded');
    }

    // Initialize History Module (Phase 8)
    if (typeof window.HistoryModule !== 'undefined') {
        try {
            if (typeof window.DataPointsManager !== 'undefined' && window.DataPointsManager) {
                window.DataPointsManager.historyModule = new window.HistoryModule(window.DataPointsManager);
                console.log('[INIT] ‚úÖ HistoryModule initialized and attached to DataPointsManager');
            } else {
                console.warn('[INIT] ‚ö†Ô∏è HistoryModule loaded but DataPointsManager not ready');
            }
        } catch (error) {
            console.error('[INIT] ‚ùå Failed to initialize HistoryModule:', error);
        }
    } else {
        console.error('[INIT] ‚ùå HistoryModule not loaded');
    }

    // Initialize Import/Export Module (Phase 8)
    if (typeof window.ImportExportModule !== 'undefined') {
        try {
            if (typeof window.DataPointsManager !== 'undefined' && window.DataPointsManager) {
                window.DataPointsManager.importExportModule = new window.ImportExportModule(window.DataPointsManager);
                console.log('[INIT] ‚úÖ ImportExportModule initialized and attached to DataPointsManager');
            } else {
                console.warn('[INIT] ‚ö†Ô∏è ImportExportModule loaded but DataPointsManager not ready');
            }
        } catch (error) {
            console.error('[INIT] ‚ùå Failed to initialize ImportExportModule:', error);
        }
    } else {
        console.error('[INIT] ‚ùå ImportExportModule not loaded');
    }

    console.log('[INIT] Phase 7 & 8 module initialization complete');
});
</script>
{% endblock %}
