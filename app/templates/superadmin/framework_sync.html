{% extends "base.html" %}

{% block title %}Framework Synchronization{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/main.css') }}">
<style>
.sync-interface {
    max-width: 1200px;
    margin: 0 auto;
}

.sync-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    padding: 20px;
}

.framework-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.company-selector {
    margin: 20px 0;
}

.company-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
}

.company-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
}

.company-item:hover {
    background-color: #f5f5f5;
    border-color: #0066cc;
}

.company-item.selected {
    background-color: #e3f2fd;
    border-color: #0066cc;
}

.company-item input[type="checkbox"] {
    margin-right: 10px;
}

.conflict-resolution {
    margin: 20px 0;
}

.conflict-options {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.conflict-option {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
}

.conflict-option:hover {
    background-color: #f5f5f5;
}

.conflict-option.selected {
    background-color: #e3f2fd;
    border-color: #0066cc;
}

.conflict-option input[type="radio"] {
    margin-right: 8px;
}

.sync-actions {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.sync-progress {
    display: none;
    margin-top: 20px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: #4caf50;
    width: 0%;
    transition: width 0.3s ease;
}

.recent-syncs {
    margin-top: 30px;
}

.sync-job-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 10px;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.status-completed {
    background-color: #d4edda;
    color: #155724;
}

.status-running {
    background-color: #fff3cd;
    color: #856404;
}

.status-failed {
    background-color: #f8d7da;
    color: #721c24;
}

.status-queued {
    background-color: #e2e3e5;
    color: #495057;
}

.alert {
    padding: 15px;
    margin: 15px 0;
    border: 1px solid transparent;
    border-radius: 6px;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

/* Enhanced Framework Selector Styles */
.framework-selector-enhanced {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    background: #fafafa;
}

.selector-controls {
    background: white;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.framework-list-container {
    margin-top: 15px;
}

.framework-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: white;
}

.framework-item {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.framework-item:last-child {
    border-bottom: none;
}

.framework-item:hover {
    background-color: #f8f9fa;
    border-left: 4px solid #0066cc;
}

.framework-item.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #0066cc;
}

.framework-item-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.framework-name {
    flex: 1;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
}

.framework-actions {
    margin-left: auto;
}

.framework-description {
    margin: 8px 0;
    color: #666;
    font-size: 0.9em;
    line-height: 1.4;
}

.framework-meta {
    margin-top: 8px;
}

.promote-btn {
    font-size: 0.8em;
    padding: 4px 8px;
}

.promote-btn:hover {
    background-color: #fff3cd;
    border-color: #ffc107;
}

/* Search and filter styling */
#framework-search {
    border-radius: 6px;
}

#company-filter {
    border-radius: 6px;
}

/* Badge adjustments */
.framework-name .badge {
    font-size: 0.7em;
    padding: 0.25em 0.5em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .framework-item-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .framework-actions {
        margin-left: 0;
        margin-top: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="sync-interface">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>Framework Synchronization</h2>
            <p>Distribute frameworks across tenants with conflict resolution.</p>
        </div>
        <div>
            <a href="{{ url_for('superadmin.sync_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Sync Dashboard
            </a>
        </div>
    </div>

    <!-- Framework Selection -->
    <div class="sync-card">
        <h3><i class="fas fa-clipboard-list"></i> Select Framework</h3>
        
        <!-- Enhanced Framework Selector -->
        <div class="framework-selector-enhanced">
            <!-- Search and Filters -->
            <div class="selector-controls mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <label for="framework-search" class="form-label">Search Frameworks:</label>
                        <input type="text" id="framework-search" class="form-control" 
                               placeholder="Search by name or description..." 
                               onkeyup="filterFrameworks()">
                    </div>
                    <div class="col-md-6">
                        <label for="company-filter" class="form-label">Filter by Company:</label>
                        <select id="company-filter" class="form-select" onchange="filterFrameworks()">
                            <option value="">All Companies</option>
                            <option value="global">Global Frameworks</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Framework List -->
            <div class="framework-list-container">
                <label class="form-label">Available Frameworks:</label>
                <div class="framework-list" id="framework-list">
                    {% for framework in frameworks %}
                    <div class="framework-item" 
                         data-framework-id="{{ framework.framework_id }}"
                         data-name="{{ framework.framework_name }}"
                         data-description="{{ framework.description or '' }}"
                         data-is-global="{{ 1 if framework.company_id == global_provider_id else 0 }}"
                         data-company-id="{{ framework.company_id }}"
                         data-company="{{ framework.company.name }}"
                         onclick="selectFramework('{{ framework.framework_id }}')">
                        
                        <div class="framework-item-header">
                            <div class="framework-name">
                                <strong>{{ framework.framework_name }}</strong>
                                {% if framework.company_id == global_provider_id %}
                                <span class="badge bg-primary ms-2">Global</span>
                                {% else %}
                                <span class="badge bg-secondary ms-2">{{ framework.company.name }}</span>
                                {% endif %}
                            </div>
                            <div class="framework-actions">
                                {% if framework.company_id != global_provider_id %}
                                <button type="button" class="btn btn-sm btn-outline-warning promote-btn" 
                                        onclick="event.stopPropagation(); promoteFramework('{{ framework.framework_id }}', '{{ framework.framework_name }}')">
                                    <i class="fas fa-level-up-alt"></i> Promote
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if framework.description %}
                        <div class="framework-description">
                            {{ framework.description[:100] }}{% if framework.description|length > 100 %}...{% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="framework-meta">
                            <small class="text-muted">
                                <i class="fas fa-building"></i> {{ framework.company.name }}
                                <span class="ms-3"><i class="fas fa-calendar"></i> {{ framework.created_at.strftime('%Y-%m-%d') }}</span>
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- No Results Message -->
                <div id="no-frameworks-message" class="text-center text-muted py-4" style="display: none;">
                    <i class="fas fa-search"></i>
                    <p class="mb-0">No frameworks match your search criteria.</p>
                </div>
            </div>
        </div>

        <!-- Selected Framework Info (Updated) -->
        <div id="framework-info" class="mt-4" style="display: none;">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Selected Framework</h5>
                <div id="framework-details">
                    <!-- Selected framework details will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Company Selection -->
    <div class="sync-card" id="company-selection" style="display: none;">
        <h3><i class="fas fa-building"></i> Select Target Companies</h3>
        <div class="company-selector">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Choose companies to sync to:</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllCompanies()">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectNoCompanies()">Select None</button>
                </div>
            </div>
            <div class="company-grid">
                {% for company in companies %}
                <div class="company-item" onclick="toggleCompany({{ company.id }})">
                    <input type="checkbox" id="company-{{ company.id }}" value="{{ company.id }}">
                    <div>
                        <strong>{{ company.name }}</strong>
                        <br>
                        <small class="text-muted">{{ company.slug }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Conflict Resolution -->
    <div class="sync-card" id="conflict-resolution" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle"></i> Conflict Resolution</h3>
        <div class="conflict-resolution">
            <p>How should conflicts be handled when frameworks or data points already exist?</p>
            <div class="conflict-options">
                <div class="conflict-option selected" onclick="selectConflictResolution('SKIP')">
                    <input type="radio" name="conflict_resolution" value="SKIP" checked>
                    <div>
                        <strong>Skip Conflicts</strong>
                        <br>
                        <small>Don't sync to companies with existing frameworks</small>
                    </div>
                </div>
                <div class="conflict-option" onclick="selectConflictResolution('OVERWRITE')">
                    <input type="radio" name="conflict_resolution" value="OVERWRITE">
                    <div>
                        <strong>Overwrite Existing</strong>
                        <br>
                        <small>Replace existing frameworks (destructive)</small>
                    </div>
                </div>
                <div class="conflict-option" onclick="selectConflictResolution('MERGE')">
                    <input type="radio" name="conflict_resolution" value="MERGE">
                    <div>
                        <strong>Merge (Coming Soon)</strong>
                        <br>
                        <small>Intelligently combine frameworks</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="sync-card" id="sync-actions" style="display: none;">
        <h3><i class="fas fa-cogs"></i> Synchronization Actions</h3>
        <div class="sync-actions">
            <button type="button" class="btn btn-primary" onclick="checkConflicts()">
                <i class="fas fa-search"></i> Check for Conflicts
            </button>
            <button type="button" class="btn btn-success" onclick="startSync()" id="start-sync-btn" disabled>
                <i class="fas fa-sync"></i> Start Synchronization
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
        
        <!-- Progress Section -->
        <div class="sync-progress" id="sync-progress">
            <h4>Synchronization Progress</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text" class="mt-2">Preparing synchronization...</div>
        </div>
    </div>

    <!-- Alerts -->
    <div id="alert-container"></div>

    <!-- Recent Sync Jobs -->
    {% if recent_sync_jobs %}
    <div class="recent-syncs">
        <h3><i class="fas fa-history"></i> Recent Synchronization Jobs</h3>
        <div class="sync-card">
            {% for job in recent_sync_jobs %}
            <div class="sync-job-item">
                <div>
                    <strong>{{ job.framework.framework_name if job.framework else 'Framework N/A' }}</strong>
                    <br>
                    <small class="text-muted">
                        {{ job.target_company_ids|length }} companies • 
                        {{ job.sync_operation.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                </div>
                <div>
                    <span class="status-badge status-{{ job.sync_operation.status.lower() }}">
                        {{ job.sync_operation.status }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Replace the old framework selection logic
let selectedFramework = null;
let selectedCompanies = [];
let conflictResolution = 'SKIP';

// New framework selection function
function selectFramework(frameworkId) {
    // Remove selection from all items
    document.querySelectorAll('.framework-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection to clicked item
    const selectedItem = document.querySelector(`[data-framework-id="${frameworkId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedFramework = frameworkId;
        
        // Update framework details
        updateFrameworkDetails(selectedItem);
        
        // Update UI state
        updateUI();
    }
}

// Enhanced framework filtering
function filterFrameworks() {
    const searchTerm = document.getElementById('framework-search').value.toLowerCase();
    const companyFilter = document.getElementById('company-filter').value;
    const frameworkItems = document.querySelectorAll('.framework-item');
    const noResultsMsg = document.getElementById('no-frameworks-message');
    
    let visibleCount = 0;
    
    frameworkItems.forEach(item => {
        const name = item.dataset.name.toLowerCase();
        const description = item.dataset.description.toLowerCase();
        const isGlobal = item.dataset.isGlobal === '1';
        const companyId = item.dataset.companyId;
        
        // Search filter
        const matchesSearch = !searchTerm || 
            name.includes(searchTerm) || 
            description.includes(searchTerm);
        
        // Company filter
        let matchesCompany = true;
        if (companyFilter === 'global') {
            matchesCompany = isGlobal;
        } else if (companyFilter && companyFilter !== '') {
            matchesCompany = companyId === companyFilter;
        }
        
        // Show/hide item
        if (matchesSearch && matchesCompany) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    noResultsMsg.style.display = visibleCount === 0 ? 'block' : 'none';
}

// Updated framework details function
function updateFrameworkDetails(selectedItem) {
    const infoDiv = document.getElementById('framework-info');
    const detailsDiv = document.getElementById('framework-details');
    
    if (!selectedItem) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const name = selectedItem.dataset.name;
    const isGlobal = selectedItem.dataset.isGlobal === '1';
    const companyName = selectedItem.dataset.company;
    const description = selectedItem.dataset.description;
    
    const typeHtml = isGlobal
        ? '<span class="badge bg-primary">Global</span>'
        : '<span class="badge bg-secondary">Company (' + companyName + ')</span>';
    
    let detailsHtml = `
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Type:</strong> ${typeHtml}</p>
        <p><strong>Owner:</strong> ${companyName}</p>
    `;
    
    if (description) {
        detailsHtml += `<p><strong>Description:</strong> ${description}</p>`;
    }
    
    detailsDiv.innerHTML = detailsHtml;
    infoDiv.style.display = 'block';
}

// Remove old framework select event listeners and update UI function
function updateUI() {
    const companySelection = document.getElementById('company-selection');
    const conflictResolutionDiv = document.getElementById('conflict-resolution');
    const syncActions = document.getElementById('sync-actions');
    const startSyncBtn = document.getElementById('start-sync-btn');
    
    // Show/hide sections based on selections
    if (selectedFramework) {
        companySelection.style.display = 'block';
        
        if (selectedCompanies.length > 0) {
            conflictResolutionDiv.style.display = 'block';
            syncActions.style.display = 'block';
            startSyncBtn.disabled = false;
        } else {
            conflictResolutionDiv.style.display = 'none';
            syncActions.style.display = 'none';
        }
    } else {
        companySelection.style.display = 'none';
        conflictResolutionDiv.style.display = 'none';
        syncActions.style.display = 'none';
    }
}

function toggleCompany(companyId) {
    const checkbox = document.getElementById(`company-${companyId}`);
    const item = checkbox.parentElement;
    
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        item.classList.add('selected');
        if (!selectedCompanies.includes(companyId)) {
            selectedCompanies.push(companyId);
        }
    } else {
        item.classList.remove('selected');
        selectedCompanies = selectedCompanies.filter(id => id !== companyId);
    }
    
    updateUI();
}

function selectAllCompanies() {
    const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]');
    selectedCompanies = [];
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        checkbox.parentElement.classList.add('selected');
        selectedCompanies.push(parseInt(checkbox.value));
    });
    
    updateUI();
}

function selectNoCompanies() {
    const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]');
    selectedCompanies = [];
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.parentElement.classList.remove('selected');
    });
    
    updateUI();
}

function selectConflictResolution(resolution) {
    // Remove selected class from all options
    document.querySelectorAll('.conflict-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    event.currentTarget.classList.add('selected');
    
    // Update radio button
    document.querySelector(`input[value="${resolution}"]`).checked = true;
    conflictResolution = resolution;
    
    updateUI();
}

function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" style="float: right;" onclick="this.parentElement.remove()"></button>
    `;
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 10000);
}

function checkConflicts() {
    if (!selectedFramework || selectedCompanies.length === 0) {
        showAlert('Please select a framework and at least one company.', 'warning');
        return;
    }
    
    showAlert('Checking for conflicts...', 'info');
    
    fetch(`/superadmin/api/sync/frameworks/${selectedFramework}/conflicts`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_company_ids: selectedCompanies
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.has_conflicts) {
                const conflictCount = data.conflicts.length;
                showAlert(`⚠️ ${conflictCount} conflicts detected. Review your conflict resolution strategy before proceeding.`, 'warning');
                
                // Show conflict details
                const conflictDetails = data.conflicts.map(conflict => 
                    `• Company ${conflict.company_id}: ${conflict.type}`
                ).join('<br>');
                
                showAlert(`<strong>Conflict Details:</strong><br>${conflictDetails}`, 'warning');
            } else {
                showAlert('✅ No conflicts detected. Safe to proceed with synchronization.', 'success');
            }
        } else {
            showAlert(`❌ Error checking conflicts: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`❌ Network error: ${error.message}`, 'danger');
    });
}

function startSync() {
    if (!selectedFramework || selectedCompanies.length === 0) {
        showAlert('Please select a framework and at least one company.', 'warning');
        return;
    }
    
    const progressDiv = document.getElementById('sync-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    progressDiv.style.display = 'block';
    progressFill.style.width = '10%';
    progressText.textContent = 'Starting synchronization...';
    
    fetch(`/superadmin/api/sync/frameworks/${selectedFramework}/distribute`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_company_ids: selectedCompanies,
            conflict_resolution: conflictResolution,
            sync_options: {}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressFill.style.width = '100%';
            progressText.textContent = 'Synchronization completed successfully!';
            showAlert(`✅ ${data.message}`, 'success');
            
            // Reset form after successful sync
            setTimeout(() => {
                resetForm();
            }, 3000);
        } else {
            progressFill.style.width = '0%';
            progressText.textContent = 'Synchronization failed';
            
            if (data.conflicts_detected) {
                showAlert(`❌ Conflicts detected: ${data.message}`, 'warning');
            } else {
                showAlert(`❌ Synchronization failed: ${data.error}`, 'danger');
            }
        }
    })
    .catch(error => {
        progressFill.style.width = '0%';
        progressText.textContent = 'Network error occurred';
        showAlert(`❌ Network error: ${error.message}`, 'danger');
    })
    .finally(() => {
        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 5000);
    });
}

function resetForm() {
    selectedFramework = null;
    selectedCompanies = [];
    conflictResolution = 'SKIP';
    
    // Clear framework selection
    document.querySelectorAll('.framework-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Clear search and filters
    document.getElementById('framework-search').value = '';
    document.getElementById('company-filter').value = '';
    filterFrameworks();
    
    selectNoCompanies();
    
    document.getElementById('company-selection').style.display = 'none';
    document.getElementById('conflict-resolution').style.display = 'none';
    document.getElementById('sync-actions').style.display = 'none';
    document.getElementById('sync-progress').style.display = 'none';
    document.getElementById('framework-info').style.display = 'none';
    
    // Clear alerts
    document.getElementById('alert-container').innerHTML = '';
    
    // Reset conflict resolution to default
    document.querySelectorAll('.conflict-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector('.conflict-option').classList.add('selected');
    document.querySelector('input[value="SKIP"]').checked = true;
}

// Initialize
document.addEventListener('DOMContentLoaded', updateUI);

// --- Promotion Logic ---
function promoteFramework(frameworkId, frameworkName) {
    if (!confirm(`Promote "${frameworkName}" to a global framework? This action cannot be undone.`)) {
        return;
    }

    showAlert('Promoting framework to global...', 'info');

    fetch(`/superadmin/api/frameworks/${frameworkId}/promote`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ Framework promoted successfully!', 'success');
            // Reload page or update option dataset
            location.reload();
        } else {
            showAlert(`❌ Promotion failed: ${data.error}`, 'danger');
        }
    })
    .catch(err => {
        showAlert(`❌ Network error: ${err.message}`, 'danger');
    });
}

// Trigger details update on page load if a value is pre-selected (e.g., after reload)
document.addEventListener('DOMContentLoaded', updateFrameworkDetails);
</script>
{% endblock %} 