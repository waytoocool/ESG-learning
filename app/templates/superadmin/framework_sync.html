{% extends "base.html" %}

{% block title %}Framework Synchronization{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/superadmin/main.css') }}">
<style>
.sync-interface {
    max-width: 1200px;
    margin: 0 auto;
}

.sync-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    padding: 20px;
}

.framework-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.company-selector {
    margin: 20px 0;
}

.company-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
}

.company-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
}

.company-item:hover {
    background-color: #f5f5f5;
    border-color: #0066cc;
}

.company-item.selected {
    background-color: #e3f2fd;
    border-color: #0066cc;
}

.company-item input[type="checkbox"] {
    margin-right: 10px;
}

.conflict-resolution {
    margin: 20px 0;
}

.conflict-options {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.conflict-option {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
}

.conflict-option:hover {
    background-color: #f5f5f5;
}

.conflict-option.selected {
    background-color: #e3f2fd;
    border-color: #0066cc;
}

.conflict-option input[type="radio"] {
    margin-right: 8px;
}

.sync-actions {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.sync-progress {
    display: none;
    margin-top: 20px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: #4caf50;
    width: 0%;
    transition: width 0.3s ease;
}

.recent-syncs {
    margin-top: 30px;
}

.sync-job-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 10px;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.status-completed {
    background-color: #d4edda;
    color: #155724;
}

.status-running {
    background-color: #fff3cd;
    color: #856404;
}

.status-failed {
    background-color: #f8d7da;
    color: #721c24;
}

.status-queued {
    background-color: #e2e3e5;
    color: #495057;
}

.alert {
    padding: 15px;
    margin: 15px 0;
    border: 1px solid transparent;
    border-radius: 6px;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}
</style>
{% endblock %}

{% block content %}
<div class="sync-interface">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>Framework Synchronization</h2>
            <p>Distribute frameworks across tenants with conflict resolution.</p>
        </div>
        <div>
            <a href="{{ url_for('superadmin.sync_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Sync Dashboard
            </a>
        </div>
    </div>

    <!-- Framework Selection -->
    <div class="sync-card">
        <h3><i class="fas fa-clipboard-list"></i> Select Framework</h3>
        <div class="framework-selector">
            <div>
                <label for="framework-select" class="form-label">Framework to Synchronize:</label>
                <select id="framework-select" class="form-select">
                    <option value="">Choose a framework...</option>
                    {% for framework in frameworks %}
                    <option value="{{ framework.framework_id }}" data-name="{{ framework.framework_name }}">
                        {{ framework.framework_name }}
                        {% if framework.description %}
                            - {{ framework.description[:50] }}{% if framework.description|length > 50 %}...{% endif %}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div id="framework-info" style="display: none;">
                <h4>Framework Details</h4>
                <div id="framework-details">
                    <!-- Framework info will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Company Selection -->
    <div class="sync-card" id="company-selection" style="display: none;">
        <h3><i class="fas fa-building"></i> Select Target Companies</h3>
        <div class="company-selector">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Choose companies to sync to:</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllCompanies()">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectNoCompanies()">Select None</button>
                </div>
            </div>
            <div class="company-grid">
                {% for company in companies %}
                <div class="company-item" onclick="toggleCompany({{ company.id }})">
                    <input type="checkbox" id="company-{{ company.id }}" value="{{ company.id }}">
                    <div>
                        <strong>{{ company.name }}</strong>
                        <br>
                        <small class="text-muted">{{ company.slug }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Conflict Resolution -->
    <div class="sync-card" id="conflict-resolution" style="display: none;">
        <h3><i class="fas fa-exclamation-triangle"></i> Conflict Resolution</h3>
        <div class="conflict-resolution">
            <p>How should conflicts be handled when frameworks or data points already exist?</p>
            <div class="conflict-options">
                <div class="conflict-option selected" onclick="selectConflictResolution('SKIP')">
                    <input type="radio" name="conflict_resolution" value="SKIP" checked>
                    <div>
                        <strong>Skip Conflicts</strong>
                        <br>
                        <small>Don't sync to companies with existing frameworks</small>
                    </div>
                </div>
                <div class="conflict-option" onclick="selectConflictResolution('OVERWRITE')">
                    <input type="radio" name="conflict_resolution" value="OVERWRITE">
                    <div>
                        <strong>Overwrite Existing</strong>
                        <br>
                        <small>Replace existing frameworks (destructive)</small>
                    </div>
                </div>
                <div class="conflict-option" onclick="selectConflictResolution('MERGE')">
                    <input type="radio" name="conflict_resolution" value="MERGE">
                    <div>
                        <strong>Merge (Coming Soon)</strong>
                        <br>
                        <small>Intelligently combine frameworks</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="sync-card" id="sync-actions" style="display: none;">
        <h3><i class="fas fa-cogs"></i> Synchronization Actions</h3>
        <div class="sync-actions">
            <button type="button" class="btn btn-primary" onclick="checkConflicts()">
                <i class="fas fa-search"></i> Check for Conflicts
            </button>
            <button type="button" class="btn btn-success" onclick="startSync()" id="start-sync-btn" disabled>
                <i class="fas fa-sync"></i> Start Synchronization
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
        
        <!-- Progress Section -->
        <div class="sync-progress" id="sync-progress">
            <h4>Synchronization Progress</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text" class="mt-2">Preparing synchronization...</div>
        </div>
    </div>

    <!-- Alerts -->
    <div id="alert-container"></div>

    <!-- Recent Sync Jobs -->
    {% if recent_sync_jobs %}
    <div class="recent-syncs">
        <h3><i class="fas fa-history"></i> Recent Synchronization Jobs</h3>
        <div class="sync-card">
            {% for job in recent_sync_jobs %}
            <div class="sync-job-item">
                <div>
                    <strong>{{ job.framework.framework_name if job.framework else 'Framework N/A' }}</strong>
                    <br>
                    <small class="text-muted">
                        {{ job.target_company_ids|length }} companies • 
                        {{ job.sync_operation.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                </div>
                <div>
                    <span class="status-badge status-{{ job.sync_operation.status.lower() }}">
                        {{ job.sync_operation.status }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
let selectedFramework = null;
let selectedCompanies = [];
let conflictResolution = 'SKIP';

function toggleCompany(companyId) {
    const checkbox = document.getElementById(`company-${companyId}`);
    const item = checkbox.parentElement;
    
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        item.classList.add('selected');
        if (!selectedCompanies.includes(companyId)) {
            selectedCompanies.push(companyId);
        }
    } else {
        item.classList.remove('selected');
        selectedCompanies = selectedCompanies.filter(id => id !== companyId);
    }
    
    updateUI();
}

function selectAllCompanies() {
    const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]');
    selectedCompanies = [];
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        checkbox.parentElement.classList.add('selected');
        selectedCompanies.push(parseInt(checkbox.value));
    });
    
    updateUI();
}

function selectNoCompanies() {
    const checkboxes = document.querySelectorAll('.company-item input[type="checkbox"]');
    selectedCompanies = [];
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.parentElement.classList.remove('selected');
    });
    
    updateUI();
}

function selectConflictResolution(resolution) {
    // Remove selected class from all options
    document.querySelectorAll('.conflict-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    event.currentTarget.classList.add('selected');
    
    // Update radio button
    document.querySelector(`input[value="${resolution}"]`).checked = true;
    conflictResolution = resolution;
    
    updateUI();
}

function updateUI() {
    const frameworkSelect = document.getElementById('framework-select');
    const companySelection = document.getElementById('company-selection');
    const conflictResolutionDiv = document.getElementById('conflict-resolution');
    const syncActions = document.getElementById('sync-actions');
    const startSyncBtn = document.getElementById('start-sync-btn');
    
    // Show/hide sections based on selections
    if (frameworkSelect.value) {
        selectedFramework = frameworkSelect.value;
        companySelection.style.display = 'block';
        
        if (selectedCompanies.length > 0) {
            conflictResolutionDiv.style.display = 'block';
            syncActions.style.display = 'block';
            startSyncBtn.disabled = false;
        } else {
            conflictResolutionDiv.style.display = 'none';
            syncActions.style.display = 'none';
        }
    } else {
        companySelection.style.display = 'none';
        conflictResolutionDiv.style.display = 'none';
        syncActions.style.display = 'none';
    }
}

function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" style="float: right;" onclick="this.parentElement.remove()"></button>
    `;
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 10000);
}

function checkConflicts() {
    if (!selectedFramework || selectedCompanies.length === 0) {
        showAlert('Please select a framework and at least one company.', 'warning');
        return;
    }
    
    showAlert('Checking for conflicts...', 'info');
    
    fetch(`/superadmin/api/sync/frameworks/${selectedFramework}/conflicts`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_company_ids: selectedCompanies
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.has_conflicts) {
                const conflictCount = data.conflicts.length;
                showAlert(`⚠️ ${conflictCount} conflicts detected. Review your conflict resolution strategy before proceeding.`, 'warning');
                
                // Show conflict details
                const conflictDetails = data.conflicts.map(conflict => 
                    `• Company ${conflict.company_id}: ${conflict.type}`
                ).join('<br>');
                
                showAlert(`<strong>Conflict Details:</strong><br>${conflictDetails}`, 'warning');
            } else {
                showAlert('✅ No conflicts detected. Safe to proceed with synchronization.', 'success');
            }
        } else {
            showAlert(`❌ Error checking conflicts: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`❌ Network error: ${error.message}`, 'danger');
    });
}

function startSync() {
    if (!selectedFramework || selectedCompanies.length === 0) {
        showAlert('Please select a framework and at least one company.', 'warning');
        return;
    }
    
    const progressDiv = document.getElementById('sync-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    progressDiv.style.display = 'block';
    progressFill.style.width = '10%';
    progressText.textContent = 'Starting synchronization...';
    
    fetch(`/superadmin/api/sync/frameworks/${selectedFramework}/distribute`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_company_ids: selectedCompanies,
            conflict_resolution: conflictResolution,
            sync_options: {}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressFill.style.width = '100%';
            progressText.textContent = 'Synchronization completed successfully!';
            showAlert(`✅ ${data.message}`, 'success');
            
            // Reset form after successful sync
            setTimeout(() => {
                resetForm();
            }, 3000);
        } else {
            progressFill.style.width = '0%';
            progressText.textContent = 'Synchronization failed';
            
            if (data.conflicts_detected) {
                showAlert(`❌ Conflicts detected: ${data.message}`, 'warning');
            } else {
                showAlert(`❌ Synchronization failed: ${data.error}`, 'danger');
            }
        }
    })
    .catch(error => {
        progressFill.style.width = '0%';
        progressText.textContent = 'Network error occurred';
        showAlert(`❌ Network error: ${error.message}`, 'danger');
    })
    .finally(() => {
        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 5000);
    });
}

function resetForm() {
    selectedFramework = null;
    selectedCompanies = [];
    conflictResolution = 'SKIP';
    
    document.getElementById('framework-select').value = '';
    selectNoCompanies();
    
    document.getElementById('company-selection').style.display = 'none';
    document.getElementById('conflict-resolution').style.display = 'none';
    document.getElementById('sync-actions').style.display = 'none';
    document.getElementById('sync-progress').style.display = 'none';
    
    // Clear alerts
    document.getElementById('alert-container').innerHTML = '';
    
    // Reset conflict resolution to default
    document.querySelectorAll('.conflict-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector('.conflict-option').classList.add('selected');
    document.querySelector('input[value="SKIP"]').checked = true;
}

// Initialize
document.getElementById('framework-select').addEventListener('change', updateUI);
document.addEventListener('DOMContentLoaded', updateUI);
</script>
{% endblock %} 