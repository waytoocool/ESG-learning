{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block extra_head %}
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Inter Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js for historical trends -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Tailwind Configuration -->
<script>
tailwind.config = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: {
                primary: {
                    50: '#f0fdf4',
                    100: '#dcfce7',
                    200: '#bbf7d0',
                    300: '#86efac',
                    400: '#4ade80',
                    500: '#16a34a',
                    600: '#15803d',
                    700: '#166534',
                    800: '#14532d',
                    900: '#052e16',
                },
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
        }
    }
}
</script>

<style>
    body {
        font-family: 'Inter', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<!-- Phase 3: Computation Context CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/computation_context.css') }}">

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="mx-auto px-2 sm:px-3 lg:px-4 py-2">
        <div class="flex items-center justify-between">
            <!-- Left: Page Title -->
            <div class="flex items-center gap-2">
                <h1 class="text-base font-bold text-gray-900 dark:text-white">Data Entry Dashboard</h1>
            </div>

            <!-- Right: User Info -->
            <div class="flex items-center gap-2">
                <div class="text-right">
                    <p class="text-xs font-medium text-gray-900 dark:text-white">{{ user_name }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">USER {{ current_user.email }} {{ current_user.company.name if current_user.company else '' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Selector Section -->
    <div class="mx-auto px-2 sm:px-3 lg:px-4 py-3">
        <div class="flex items-center justify-between">
            <!-- Entity Switcher -->
            <div class="flex items-center gap-4">
                <!-- Entity Selector -->
                <div class="flex items-center gap-2">
                    {% if user_role == 'ADMIN' and entities|length > 1 %}
                    <span class="material-icons text-gray-500 dark:text-gray-400">apartment</span>
                    <label for="entitySelect" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        Data for:
                    </label>
                    <select id="entitySelect" class="block rounded-lg border-gray-300 dark:border-gray-600 dark:bg-white dark:text-gray-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm py-1.5 px-3">
                        {% for entity in entities %}
                        <option value="{{ entity.id }}" {% if entity.is_current %}selected{% endif %}>
                            {{ entity.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% elif current_entity %}
                    <span class="material-icons text-gray-500 dark:text-gray-400">apartment</span>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Data for:</span>
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ current_entity.name }}</span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        {{ current_entity.type }}
                    </span>
                    {% endif %}
                </div>

                <!-- Fiscal Year Selector -->
                <div class="flex items-center gap-2 border-l border-gray-300 dark:border-gray-600 pl-4">
                    <span class="material-icons text-gray-500 dark:text-gray-400">calendar_today</span>
                    <label for="fySelect" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        Fiscal Year:
                    </label>
                    <select id="fySelect" class="block rounded-lg border-gray-300 dark:border-gray-600 dark:bg-white dark:text-gray-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm py-1.5 px-3">
                        {% for fy_year, fy_label in fy_year_list %}
                        <option value="{{ fy_year }}" {% if fy_year == current_fy_year %}selected{% endif %}>
                            {{ fy_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Toggle Button -->
            <button id="toggleViewBtn" class="inline-flex items-center gap-1 text-sm text-primary-600 dark:text-primary-500 hover:underline">
                <span class="material-icons text-sm">swap_horiz</span>
                Legacy View
            </button>
        </div>
    </div>

    <!-- Error Message Display -->
    {% if error_message %}
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="rounded-lg bg-red-50 dark:bg-red-900/20 p-4 border border-red-200 dark:border-red-800">
            <div class="flex">
                <span class="material-icons text-red-400 mr-3">error</span>
                <p class="text-sm text-red-800 dark:text-red-200">{{ error_message }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Assigned Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-blue-100 dark:bg-blue-900/50 rounded-full">
                                <span class="material-icons text-blue-500 text-2xl">list_alt</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Assigned Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">{{ total_fields }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-green-100 dark:bg-green-900/50 rounded-full">
                                <span class="material-icons text-green-500 text-2xl">check_circle</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Completed Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'complete')|list|length + computed_fields|selectattr('status', 'equalto', 'complete')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-full">
                                <span class="material-icons text-yellow-500 text-2xl">pending</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Pending Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'pending')|list|length + computed_fields|selectattr('status', 'equalto', 'pending')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overdue Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-red-100 dark:bg-red-900/50 rounded-full">
                                <span class="material-icons text-red-500 text-2xl">warning</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Overdue Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'overdue')|list|length + computed_fields|selectattr('status', 'equalto', 'overdue')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- Search Box -->
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-icons text-gray-400 text-sm">search</span>
                        </div>
                        <input type="text" id="searchMetrics" placeholder="Search metrics..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                    </div>
                </div>

                <!-- Filter: Status -->
                <div class="sm:w-48">
                    <select id="filterStatus" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Statuses</option>
                        <option value="complete">Complete</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>

                <!-- Filter: Category -->
                <div class="sm:w-48">
                    <select id="filterCategory" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Categories</option>
                        <option value="energy">Energy</option>
                        <option value="emissions">Emissions</option>
                        <option value="social">Social</option>
                        <option value="governance">Governance</option>
                    </select>
                </div>

                <!-- Filter: Field Type -->
                <div class="sm:w-48">
                    <select id="filterFieldType" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Field Types</option>
                        <option value="raw">Raw Input</option>
                        <option value="computed">Computed</option>
                    </select>
                </div>

                <!-- Enhancement #4: Bulk Upload Button -->
                <div>
                    <button id="open-bulk-upload" class="inline-flex items-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                        <span class="material-icons text-sm">upload_file</span>
                        Bulk Upload Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Points Grid -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {% set all_fields = raw_input_fields + computed_fields %}
        {% set fields_by_category = {} %}

        {# Group fields by category/topic #}
        {% for field in all_fields %}
            {% set category = field.topic_name or 'Uncategorized' %}
            {% if category not in fields_by_category %}
                {% set _ = fields_by_category.update({category: []}) %}
            {% endif %}
            {% set _ = fields_by_category[category].append(field) %}
        {% endfor %}

        <!-- Category Icons Mapping -->
        {% set category_icons = {
            'Energy': 'bolt',
            'Emissions': 'cloud',
            'Social': 'groups',
            'Governance': 'gavel',
            'Water': 'water_drop',
            'Waste': 'delete',
            'Biodiversity': 'nature',
            'Uncategorized': 'folder'
        } %}

        <!-- Render Each Category -->
        {% for category, fields in fields_by_category.items() %}
        <div class="mb-8 category-section" data-category="{{ category.lower() }}">
            <!-- Category Header -->
            <div class="flex items-center mb-4">
                <span class="material-icons text-primary-600 dark:text-primary-500 mr-2">
                    {{ category_icons.get(category, 'folder') }}
                </span>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{{ category }}</h2>
                <span class="ml-3 inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">
                    {{ fields|length }} {{ 'field' if fields|length == 1 else 'fields' }}
                </span>
            </div>

            <!-- Fields Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {% for field in fields %}
                {% set is_computed = field.field_name in (computed_fields|map(attribute='field_name')|list) %}

                <div class="field-card bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition-shadow duration-200 overflow-hidden border border-gray-200 dark:border-gray-700 {{ 'computed-field' if is_computed else 'raw-field' }}"
                     data-field-type="{{ 'computed' if is_computed else 'raw' }}"
                     data-field-name="{{ field.field_name|lower }}"
                     data-status="{{ field.status or 'pending' }}">

                    <!-- Card Header with Status Badge -->
                    <div class="px-4 pt-4 pb-2">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 min-h-[2.5rem]">
                                    {{ field.field_name }}
                                </h3>
                            </div>
                            <div class="ml-2">
                                {% if field.status == 'complete' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                    Complete
                                </span>
                                {% elif field.status == 'overdue' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
                                    <span class="material-icons text-xs mr-1">warning</span>
                                    Overdue
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                                    Pending
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="px-4 py-3 space-y-2">
                        <!-- Field Type Badge -->
                        <div class="flex items-center gap-2">
                            {% if is_computed %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                <span class="material-icons text-xs mr-1">functions</span>
                                Computed
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                <span class="material-icons text-xs mr-1">edit</span>
                                Raw Input
                            </span>
                            {% endif %}

                            <!-- Frequency Badge -->
                            {% if field.frequency %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                                {% if field.frequency == 'Annual' %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200
                                {% elif field.frequency == 'Quarterly' %}bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200
                                {% elif field.frequency == 'Monthly' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200
                                {% else %}bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200{% endif %}">
                                {{ field.frequency }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Unit -->
                        {% if field.default_unit %}
                        <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                            <span class="material-icons text-xs mr-1">straighten</span>
                            <span>{{ field.default_unit }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Card Footer with Action Buttons -->
                    <div class="px-4 pb-4">
                        {% if is_computed %}
                        <div class="flex gap-2">
                            <button class="open-data-modal flex-1 inline-flex items-center justify-center px-3 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                    data-field-id="{{ field.field_id }}"
                                    data-field-name="{{ field.field_name }}"
                                    data-field-type="computed">
                                <span class="material-icons text-sm mr-1">visibility</span>
                                View Data
                            </button>
                            <button class="show-computation-context inline-flex items-center justify-center px-3 py-2.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                    data-field-id="{{ field.field_id }}"
                                    title="View Calculation">
                                <span class="material-icons text-sm">functions</span>
                            </button>
                        </div>
                        {% else %}
                        <button class="open-data-modal w-full inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                data-field-id="{{ field.field_id }}"
                                data-field-name="{{ field.field_name }}"
                                data-field-type="raw_input">
                            <span class="material-icons text-sm mr-2">edit</span>
                            Enter Data
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Data Collection Modal (Keep existing Bootstrap modal for compatibility) -->
    <div class="modal fade" id="dataCollectionModal" tabindex="-1" aria-labelledby="dataCollectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h2 class="modal-title" id="dataCollectionModalLabel">
                        Enter Data: <span id="modalFieldName">Field Name</span>
                    </h2>
                    <div class="modal-header-right">
                        <div class="auto-save-status-container"></div>
                        <button type="button" class="btn-close modal-close" data-bs-dismiss="modal" aria-label="Close">
                            &times;
                        </button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="modal-tabs">
                    <button class="tab active" data-tab="entry" id="tab-entry">Current Entry</button>
                    <button class="tab" data-tab="history" id="tab-history">Historical Data</button>
                    <button class="tab" data-tab="info" id="tab-info">Field Info</button>
                </div>

                <!-- Tab Content -->
                <div class="modal-body">
                    <!-- Current Entry Tab -->
                    <div class="tab-content active" id="entry-tab">
                        <!-- Data Entry Form Container (for raw input fields) -->
                        <div id="data-entry-form-container" style="display: block;">
                            <form id="dataEntryForm">
                                <!-- Smart Date Selector -->
                                <div class="mb-4">
                                    <div id="dateSelectorContainer">
                                        <!-- Date selector will be rendered here by DateSelector component -->
                                        <div class="text-center text-muted py-3">
                                            <span class="material-icons">event</span>
                                            <p class="mb-0">Loading dates...</p>
                                        </div>
                                    </div>
                                    <input type="hidden" id="reportingDate" name="reporting_date" required>
                                </div>

                                <div class="mb-3">
                                    <label for="dataValue" class="form-label">Value</label>
                                    <input type="text" class="form-control" id="dataValue" required>
                                </div>

                                <!-- Dimensional Data Matrix Container -->
                                <div class="mb-3" id="dimensionMatrixContainer" style="display: none;">
                                    <!-- Dimensional matrix will be rendered here by DimensionalDataHandler -->
                                </div>

                                <!-- Enhancement #2: Notes/Comments Section -->
                                <div class="mb-3" id="notesSection">
                                    <label for="fieldNotes" class="form-label">
                                        <span class="material-icons text-sm align-middle">comment</span>
                                        Notes / Comments <span class="text-muted">(Optional)</span>
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="fieldNotes"
                                        rows="4"
                                        maxlength="1000"
                                        placeholder="Add context about unusual values, data sources, methodology, or clarifications for reviewers..."
                                    ></textarea>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <small class="form-text text-muted">
                                            <span class="material-icons text-xs align-middle">info</span>
                                            Provide context to help reviewers understand this data entry
                                        </small>
                                        <small class="char-counter text-muted">
                                            <span id="notesCharCount">0</span> / 1000 characters
                                        </small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">File Attachments</label>
                                    <div class="file-upload-area" id="fileUploadArea">
                                        <span class="material-icons-outlined">cloud_upload</span>
                                        <p><strong>Click to upload</strong> or drag and drop</p>
                                        <input type="file" id="fileInput" multiple style="display: none;">
                                    </div>
                                    <div id="fileList" class="mt-2"></div>
                                </div>
                            </form>
                        </div>

                        <!-- Computed Field View Container (for computed fields) -->
                        <div id="computed-field-view-container" style="display: none;">
                            <!-- Computed field view will be rendered here by ComputedFieldView component -->
                        </div>
                    </div>

                    <!-- Historical Data Tab -->
                    <div class="tab-content" id="history-tab">
                        <div id="historicalDataContent">
                            <p class="text-muted">Loading historical data...</p>
                        </div>
                    </div>

                    <!-- Field Info Tab -->
                    <div class="tab-content" id="info-tab">
                        <div id="fieldInfoContent">
                            <p class="text-muted">Loading field information...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-submit" id="submitDataBtn">Save Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Computation Context Modal (Phase 3) -->
    <dialog id="computationContextModal" class="modal">
        <div class="modal-header">
            <h2>Computation Context</h2>
            <button class="btn-close close-btn" onclick="document.getElementById('computationContextModal').close()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="context-container">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </dialog>

    <!-- Enhancement #4: Bulk Upload Modal -->
    {% include 'user_v2/_bulk_upload_modal.html' %}
</div>

<!-- Dashboard Modal Styles (external file) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/dashboard_modal.css') }}">

<!-- Session Handler - MUST load first to handle session expiration globally -->
<script src="{{ url_for('static', filename='js/common/session_handler.js') }}"></script>

<!-- Modular JavaScript - Dashboard Core Functionality -->
<script src="{{ url_for('static', filename='js/user_v2/notes_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/form_validation.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/search_filter.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/modal_manager.js') }}"></script>

<script>
// Set global context variables for modular scripts
window.currentEntityId = {{ current_entity.id if current_entity else 'null' }};
window.currentFYYear = {{ current_fy_year if current_fy_year else 'null' }};
</script>

<!-- Phase 2: Dimensional Data Handler -->
<script src="{{ url_for('static', filename='js/user_v2/dimensional_data_handler.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/dimensional_grid.css') }}">

<!-- Data Submission Handler -->
<script src="{{ url_for('static', filename='js/user_v2/data_submission.js') }}"></script>

<!-- Validation Engine: Modal CSS & JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/validation_modal.css') }}">
<script src="{{ url_for('static', filename='js/user_v2/validation_modal.js') }}"></script>

<!-- Phase 3: Load Computation Context Handler -->
<script src="{{ url_for('static', filename='js/user_v2/computation_context_handler.js') }}"></script>

<!-- Phase 4: Advanced Features - CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/phase4_features.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/date_selector.css') }}">

<!-- Enhancement #3: File Upload - CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/file_upload.css') }}">

<!-- Phase 4: Advanced Features - JavaScript Handlers -->
<script src="{{ url_for('static', filename='js/user_v2/auto_save_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/keyboard_shortcuts.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/number_formatter.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/bulk_paste_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/performance_optimizer.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/date_selector.js') }}"></script>

<!-- Enhancement #3: File Upload - JavaScript -->
<script src="{{ url_for('static', filename='js/user_v2/file_upload_handler.js') }}"></script>

<!-- Enhancement #1: Computed Field Modal - CSS & JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/computed_field_view.css') }}">
<script src="{{ url_for('static', filename='js/user_v2/computed_field_view.js') }}"></script>

<!-- Enhancement #4: Bulk Excel Upload - CSS & JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/bulk_upload.css') }}">
<script src="{{ url_for('static', filename='js/user_v2/bulk_upload_handler.js') }}"></script>

<!-- Dashboard Initialization - Phase 4 Advanced Features -->
<script src="{{ url_for('static', filename='js/user_v2/dashboard_init.js') }}"></script>

{% endblock %}
