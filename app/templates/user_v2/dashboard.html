{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block extra_head %}
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Inter Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js for historical trends -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Tailwind Configuration -->
<script>
tailwind.config = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: {
                primary: {
                    50: '#f0fdf4',
                    100: '#dcfce7',
                    200: '#bbf7d0',
                    300: '#86efac',
                    400: '#4ade80',
                    500: '#16a34a',
                    600: '#15803d',
                    700: '#166534',
                    800: '#14532d',
                    900: '#052e16',
                },
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
        }
    }
}
</script>

<style>
    body {
        font-family: 'Inter', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<!-- Phase 3: Computation Context CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/computation_context.css') }}">

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="mx-auto px-2 sm:px-3 lg:px-4 py-2">
        <div class="flex items-center justify-between">
            <!-- Left: Page Title -->
            <div class="flex items-center gap-2">
                <h1 class="text-base font-bold text-gray-900 dark:text-white">Data Entry Dashboard</h1>
            </div>

            <!-- Right: User Info -->
            <div class="flex items-center gap-2">
                <div class="text-right">
                    <p class="text-xs font-medium text-gray-900 dark:text-white">{{ user_name }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">USER {{ current_user.email }} {{ current_user.company.name if current_user.company else '' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Selector Section -->
    <div class="mx-auto px-2 sm:px-3 lg:px-4 py-3">
        <div class="flex items-center justify-between">
            <!-- Entity Switcher -->
            <div class="flex items-center gap-2">
                {% if user_role == 'ADMIN' and entities|length > 1 %}
                <span class="material-icons text-gray-500 dark:text-gray-400">apartment</span>
                <label for="entitySelect" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    Data for:
                </label>
                <select id="entitySelect" class="block rounded-lg border-gray-300 dark:border-gray-600 dark:bg-white dark:text-gray-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm py-1.5 px-3">
                    {% for entity in entities %}
                    <option value="{{ entity.id }}" {% if entity.is_current %}selected{% endif %}>
                        {{ entity.name }}
                    </option>
                    {% endfor %}
                </select>
                {% elif current_entity %}
                <span class="material-icons text-gray-500 dark:text-gray-400">apartment</span>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Data for:</span>
                <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ current_entity.name }}</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                    {{ current_entity.type }}
                </span>
                {% endif %}
            </div>

            <!-- Toggle Button -->
            <button id="toggleViewBtn" class="inline-flex items-center gap-1 text-sm text-primary-600 dark:text-primary-500 hover:underline">
                <span class="material-icons text-sm">swap_horiz</span>
                Legacy View
            </button>
        </div>
    </div>

    <!-- Error Message Display -->
    {% if error_message %}
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="rounded-lg bg-red-50 dark:bg-red-900/20 p-4 border border-red-200 dark:border-red-800">
            <div class="flex">
                <span class="material-icons text-red-400 mr-3">error</span>
                <p class="text-sm text-red-800 dark:text-red-200">{{ error_message }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Total Data Requests -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-blue-100 dark:bg-blue-900/50 rounded-full">
                                <span class="material-icons text-blue-500 text-2xl">list_alt</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Total Data Requests</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">{{ total_fields }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Requests -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-green-100 dark:bg-green-900/50 rounded-full">
                                <span class="material-icons text-green-500 text-2xl">check_circle</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Completed Requests</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'complete')|list|length + computed_fields|selectattr('status', 'equalto', 'complete')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Selector -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-purple-100 dark:bg-purple-900/50 rounded-full">
                                <span class="material-icons text-purple-500 text-2xl">calendar_today</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Reporting Date</dt>
                                <dd class="mt-1">
                                    <input type="date" id="selectedDate" value="{{ selected_date }}" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Requests -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-full">
                                <span class="material-icons text-yellow-500 text-2xl">pending</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Pending<br>Requests</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|rejectattr('status', 'equalto', 'complete')|list|length + computed_fields|rejectattr('status', 'equalto', 'complete')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- Search Box -->
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-icons text-gray-400 text-sm">search</span>
                        </div>
                        <input type="text" id="searchMetrics" placeholder="Search metrics..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                    </div>
                </div>

                <!-- Filter: Status -->
                <div class="sm:w-48">
                    <select id="filterStatus" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Statuses</option>
                        <option value="complete">Complete</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>

                <!-- Filter: Category -->
                <div class="sm:w-48">
                    <select id="filterCategory" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Categories</option>
                        <option value="energy">Energy</option>
                        <option value="emissions">Emissions</option>
                        <option value="social">Social</option>
                        <option value="governance">Governance</option>
                    </select>
                </div>

                <!-- Filter: Field Type -->
                <div class="sm:w-48">
                    <select id="filterFieldType" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Field Types</option>
                        <option value="raw">Raw Input</option>
                        <option value="computed">Computed</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Points Grid -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {% set all_fields = raw_input_fields + computed_fields %}
        {% set fields_by_category = {} %}

        {# Group fields by category/topic #}
        {% for field in all_fields %}
            {% set category = field.topic_name or 'Uncategorized' %}
            {% if category not in fields_by_category %}
                {% set _ = fields_by_category.update({category: []}) %}
            {% endif %}
            {% set _ = fields_by_category[category].append(field) %}
        {% endfor %}

        <!-- Category Icons Mapping -->
        {% set category_icons = {
            'Energy': 'bolt',
            'Emissions': 'cloud',
            'Social': 'groups',
            'Governance': 'gavel',
            'Water': 'water_drop',
            'Waste': 'delete',
            'Biodiversity': 'nature',
            'Uncategorized': 'folder'
        } %}

        <!-- Render Each Category -->
        {% for category, fields in fields_by_category.items() %}
        <div class="mb-8 category-section" data-category="{{ category.lower() }}">
            <!-- Category Header -->
            <div class="flex items-center mb-4">
                <span class="material-icons text-primary-600 dark:text-primary-500 mr-2">
                    {{ category_icons.get(category, 'folder') }}
                </span>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{{ category }}</h2>
                <span class="ml-3 inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">
                    {{ fields|length }} {{ 'field' if fields|length == 1 else 'fields' }}
                </span>
            </div>

            <!-- Fields Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {% for field in fields %}
                {% set is_computed = field.field_name in (computed_fields|map(attribute='field_name')|list) %}

                <div class="field-card bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition-shadow duration-200 overflow-hidden border border-gray-200 dark:border-gray-700 {{ 'computed-field' if is_computed else 'raw-field' }}"
                     data-field-type="{{ 'computed' if is_computed else 'raw' }}"
                     data-field-name="{{ field.field_name|lower }}"
                     data-status="{{ field.status or 'pending' }}">

                    <!-- Card Header with Status Badge -->
                    <div class="px-4 pt-4 pb-2">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 min-h-[2.5rem]">
                                    {{ field.field_name }}
                                </h3>
                            </div>
                            <div class="ml-2">
                                {% if field.status == 'complete' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                    Complete
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                                    Pending
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="px-4 py-3 space-y-2">
                        <!-- Field Type Badge -->
                        <div class="flex items-center gap-2">
                            {% if is_computed %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                <span class="material-icons text-xs mr-1">functions</span>
                                Computed
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                <span class="material-icons text-xs mr-1">edit</span>
                                Raw Input
                            </span>
                            {% endif %}

                            <!-- Frequency Badge -->
                            {% if field.frequency %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                                {% if field.frequency == 'Annual' %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200
                                {% elif field.frequency == 'Quarterly' %}bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200
                                {% elif field.frequency == 'Monthly' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200
                                {% else %}bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200{% endif %}">
                                {{ field.frequency }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Unit -->
                        {% if field.default_unit %}
                        <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                            <span class="material-icons text-xs mr-1">straighten</span>
                            <span>{{ field.default_unit }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Card Footer with Action Buttons -->
                    <div class="px-4 pb-4">
                        {% if is_computed %}
                        <div class="flex gap-2">
                            <button class="open-data-modal flex-1 inline-flex items-center justify-center px-3 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                    data-field-id="{{ field.field_id }}"
                                    data-field-name="{{ field.field_name }}"
                                    data-field-type="computed">
                                <span class="material-icons text-sm mr-1">visibility</span>
                                View Data
                            </button>
                            <button class="show-computation-context inline-flex items-center justify-center px-3 py-2.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                    data-field-id="{{ field.field_id }}"
                                    title="View Calculation">
                                <span class="material-icons text-sm">functions</span>
                            </button>
                        </div>
                        {% else %}
                        <button class="open-data-modal w-full inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                data-field-id="{{ field.field_id }}"
                                data-field-name="{{ field.field_name }}"
                                data-field-type="raw_input">
                            <span class="material-icons text-sm mr-2">edit</span>
                            Enter Data
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Data Collection Modal (Keep existing Bootstrap modal for compatibility) -->
    <div class="modal fade" id="dataCollectionModal" tabindex="-1" aria-labelledby="dataCollectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-container">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h2 class="modal-title" id="dataCollectionModalLabel">
                        Enter Data: <span id="modalFieldName">Field Name</span> -
                        <span id="modalEntityName">{{ current_entity.name if current_entity else 'Entity' }}</span>
                    </h2>
                    <button type="button" class="btn-close modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Tab Navigation -->
                <div class="modal-tabs">
                    <button class="tab active" data-tab="entry" id="tab-entry">Current Entry</button>
                    <button class="tab" data-tab="history" id="tab-history">Historical Data</button>
                    <button class="tab" data-tab="info" id="tab-info">Field Info</button>
                </div>

                <!-- Tab Content -->
                <div class="modal-body">
                    <!-- Current Entry Tab -->
                    <div class="tab-content active" id="entry-tab">
                        <form id="dataEntryForm">
                            <div class="mb-3">
                                <label for="reportingDate" class="form-label">Reporting Date</label>
                                <input type="date" class="form-control" id="reportingDate" required>
                            </div>

                            <div class="mb-3">
                                <label for="dataValue" class="form-label">Value</label>
                                <input type="text" class="form-control" id="dataValue" required>
                            </div>

                            <!-- Dimensional Data Matrix Container -->
                            <div class="mb-3" id="dimensionMatrixContainer" style="display: none;">
                                <!-- Dimensional matrix will be rendered here by DimensionalDataHandler -->
                            </div>

                            <div class="mb-3">
                                <label class="form-label">File Attachments</label>
                                <div class="file-upload-area" id="fileUploadArea">
                                    <p>Drag and drop files here or click to browse</p>
                                    <input type="file" id="fileInput" multiple style="display: none;">
                                </div>
                                <div id="fileList" class="mt-2"></div>
                            </div>
                        </form>
                    </div>

                    <!-- Historical Data Tab -->
                    <div class="tab-content" id="history-tab">
                        <div id="historicalDataContent">
                            <p class="text-muted">Loading historical data...</p>
                        </div>
                    </div>

                    <!-- Field Info Tab -->
                    <div class="tab-content" id="info-tab">
                        <div id="fieldInfoContent">
                            <p class="text-muted">Loading field information...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary btn-save-draft" id="saveDraftBtn">Save Draft</button>
                    <button type="button" class="btn btn-primary btn-submit" id="submitDataBtn">Submit Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Computation Context Modal (Phase 3) -->
    <dialog id="computationContextModal" class="modal">
        <div class="modal-header">
            <h2>Computation Context</h2>
            <button class="btn-close close-btn" onclick="document.getElementById('computationContextModal').close()" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
            <div class="context-container">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </dialog>
</div>

<!-- Keep all existing custom styles that don't conflict with Tailwind -->
<style>
/* Modal Styles (Bootstrap compatibility) */
.modal-xl {
    max-width: 90%;
}

.modal-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 20px 30px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-tabs {
    display: flex;
    border-bottom: 2px solid #dee2e6;
    padding: 0 30px;
    gap: 10px;
}

.modal-tabs .tab {
    padding: 12px 24px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: all 0.3s;
}

.modal-tabs .tab.active {
    color: #16a34a;
    border-bottom-color: #16a34a;
}

.modal-tabs .tab:hover {
    color: #16a34a;
    background: rgba(22, 163, 74, 0.05);
}

.modal-body {
    padding: 30px;
    min-height: 400px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.file-upload-area:hover {
    border-color: #16a34a;
    background: rgba(22, 163, 74, 0.05);
}

.modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Dark mode for modals */
.dark .modal-container {
    background: #1f2937;
    color: white;
}

.dark .modal-header,
.dark .modal-footer {
    border-color: #374151;
}

.dark .file-upload-area {
    border-color: #374151;
    color: #9ca3af;
}

.dark .file-upload-area:hover {
    border-color: #16a34a;
}

/* Line clamp utility for field names */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Smooth transitions for cards */
.field-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.field-card:hover {
    transform: translateY(-2px);
}

/* Computed field special styling */
.computed-field {
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
}

.dark .computed-field {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
}
</style>

<!-- Keep ALL existing Phase 2, 3, and 4 JavaScript from original template -->
<script>
// Phase 1: Basic Modal Functionality
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('dataCollectionModal'));

    // Open modal when clicking "Enter Data" buttons
    document.querySelectorAll('.open-data-modal').forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.dataset.fieldId;
            const fieldName = this.dataset.fieldName;
            const fieldType = this.dataset.fieldType;

            document.getElementById('modalFieldName').textContent = fieldName;

            // Load field details via API (placeholder for Phase 2)
            console.log('Opening modal for field:', fieldId, fieldType);

            modal.show();
        });
    });

    // Tab switching
    document.querySelectorAll('.modal-tabs .tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;

            // Update tab buttons
            document.querySelectorAll('.modal-tabs .tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        });
    });

    // Entity switcher (for admins)
    const entitySelect = document.getElementById('entitySelect');
    if (entitySelect) {
        entitySelect.addEventListener('change', function() {
            const entityId = this.value;
            console.log('Switching to entity:', entityId);
        });
    }

    // File upload area
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');

    if (fileUploadArea && fileInput) {
        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#16a34a';
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#dee2e6';
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#dee2e6';

            const files = e.dataTransfer.files;
            console.log('Files dropped:', files.length);
        });

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            console.log('Files selected:', files.length);
        });
    }

    // Toggle button to switch back to legacy dashboard
    const toggleViewBtn = document.getElementById('toggleViewBtn');
    if (toggleViewBtn) {
        toggleViewBtn.addEventListener('click', function() {
            window.location.href = '{{ url_for("user.dashboard") }}';
        });
    }

    // Search and Filter Functionality
    const searchInput = document.getElementById('searchMetrics');
    const filterStatus = document.getElementById('filterStatus');
    const filterCategory = document.getElementById('filterCategory');
    const filterFieldType = document.getElementById('filterFieldType');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilter = filterStatus.value;
        const categoryFilter = filterCategory.value.toLowerCase();
        const fieldTypeFilter = filterFieldType.value;

        document.querySelectorAll('.field-card').forEach(card => {
            const fieldName = card.dataset.fieldName;
            const status = card.dataset.status;
            const fieldType = card.dataset.fieldType;
            const category = card.closest('.category-section').dataset.category;

            const matchesSearch = !searchTerm || fieldName.includes(searchTerm);
            const matchesStatus = !statusFilter || status === statusFilter;
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesFieldType = !fieldTypeFilter || fieldType === fieldTypeFilter;

            if (matchesSearch && matchesStatus && matchesCategory && matchesFieldType) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        // Hide/show category sections if all cards are hidden
        document.querySelectorAll('.category-section').forEach(section => {
            const visibleCards = section.querySelectorAll('.field-card[style="display: block;"], .field-card:not([style*="display"])');
            if (visibleCards.length === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        });
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (filterStatus) filterStatus.addEventListener('change', applyFilters);
    if (filterCategory) filterCategory.addEventListener('change', applyFilters);
    if (filterFieldType) filterFieldType.addEventListener('change', applyFilters);
});
</script>

<!-- Phase 2: Dimensional Data Handler -->
<script src="{{ url_for('static', filename='js/user_v2/dimensional_data_handler.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/dimensional_grid.css') }}">

<script>
// Initialize Dimensional Data Handler
let dimensionalDataHandler = null;

document.addEventListener('DOMContentLoaded', function() {
    const dimensionContainer = document.getElementById('dimensionMatrixContainer');
    if (dimensionContainer) {
        dimensionalDataHandler = new DimensionalDataHandler(dimensionContainer);
    }

    // Enhanced modal open to check for dimensional fields
    document.querySelectorAll('.open-data-modal').forEach(button => {
        button.addEventListener('click', async function() {
            const fieldId = this.dataset.fieldId;
            const entityId = {{ current_entity.id if current_entity else 'null' }};
            const reportingDate = document.getElementById('reportingDate')?.value;

            // Store field ID globally for auto-save to access
            window.currentFieldId = fieldId;

            if (dimensionalDataHandler && fieldId && entityId) {
                try {
                    // Load dimension matrix
                    const matrix = await dimensionalDataHandler.loadDimensionMatrix(
                        fieldId,
                        entityId,
                        reportingDate || new Date().toISOString().split('T')[0]
                    );

                    // Show/hide dimensional matrix based on field
                    const matrixContainer = document.getElementById('dimensionMatrixContainer');
                    const valueInput = document.getElementById('dataValue').closest('.mb-3');

                    if (matrix.has_dimensions) {
                        matrixContainer.style.display = 'block';
                        valueInput.style.display = 'none';

                        if (window.attachNumberFormatters) {
                            setTimeout(() => {
                                window.attachNumberFormatters(matrixContainer);
                                console.log('[Phase 4] ✅ Number formatters attached to dimensional inputs');
                            }, 50);
                        }
                    } else {
                        matrixContainer.style.display = 'none';
                        valueInput.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading dimension matrix:', error);
                }
            }
        });
    });

    // Enhanced submit button to handle dimensional data
    const submitBtn = document.getElementById('submitDataBtn');
    if (submitBtn && dimensionalDataHandler) {
        submitBtn.addEventListener('click', async function() {
            try {
                const matrixContainer = document.getElementById('dimensionMatrixContainer');

                if (matrixContainer.style.display !== 'none' && dimensionalDataHandler.currentMatrix) {
                    await dimensionalDataHandler.submitDimensionalData();
                } else {
                    console.log('Submitting simple data...');
                }
            } catch (error) {
                console.error('Error submitting data:', error);
            }
        });
    }

    // Phase 3: Computation Context Handler
    document.querySelectorAll('.show-computation-context').forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.dataset.fieldId;
            const entityId = {{ current_entity.id if current_entity else 'null' }};
            const reportingDate = document.getElementById('selectedDate').value || '{{ selected_date }}';

            if (window.showComputationContext) {
                window.showComputationContext(fieldId, entityId, reportingDate);
            } else {
                console.error('Computation context handler not loaded');
            }
        });
    });
});
</script>

<!-- Phase 3: Load Computation Context Handler -->
<script src="{{ url_for('static', filename='js/user_v2/computation_context_handler.js') }}"></script>

<!-- Phase 4: Advanced Features - CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/phase4_features.css') }}">

<!-- Phase 4: Advanced Features - JavaScript Handlers -->
<script src="{{ url_for('static', filename='js/user_v2/auto_save_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/keyboard_shortcuts.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/number_formatter.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/bulk_paste_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/performance_optimizer.js') }}"></script>

<script>
// Phase 4: Initialize advanced features (Keep ALL existing Phase 4 code from original)
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Phase 4] Initializing advanced features...');

    // Initialize keyboard shortcuts globally
    try {
        if (typeof KeyboardShortcutHandler !== 'undefined') {
            window.keyboardShortcuts = new KeyboardShortcutHandler({
                onSave: function() {
                    if (autoSaveHandler && autoSaveHandler.isActive) {
                        autoSaveHandler.forceSave();
                    } else {
                        console.log('[Keyboard] Save triggered but auto-save not active');
                    }
                },
                onSubmit: function() {
                    const submitBtn = document.querySelector('#dataCollectionModal .btn-primary[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                },
                onClose: function() {
                    const modal = document.getElementById('dataCollectionModal');
                    if (modal) {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }
                }
            });
            window.keyboardShortcuts.enable();
            console.log('[Phase 4] ✅ Keyboard shortcuts initialized');
        }
    } catch (error) {
        console.error('[Phase 4] Error initializing keyboard shortcuts:', error);
    }

    // Initialize performance optimizer
    try {
        if (typeof PerformanceOptimizer !== 'undefined') {
            window.perfOptimizer = new PerformanceOptimizer({
                enableLazyLoading: true,
                enableCaching: true,
                enableWebWorkers: false
            });
            window.perfOptimizer.initialize();
            console.log('[Phase 4] ✅ Performance optimizer initialized');
        }
    } catch (error) {
        console.error('[Phase 4] Error initializing performance optimizer:', error);
    }

    // Initialize number formatter for all number inputs
    try {
        if (typeof NumberFormatter !== 'undefined') {
            window.attachNumberFormatters = function(container) {
                const selector = container
                    ? container.querySelectorAll('input[type="number"], input[data-format="number"]')
                    : document.querySelectorAll('input[type="number"], input[data-format="number"]');

                selector.forEach(input => {
                    if (input._numberFormatter) return;

                    const formatter = new NumberFormatter({
                        fieldType: input.dataset.fieldType || 'DECIMAL',
                        unit: input.dataset.unit || '',
                        decimals: input.dataset.decimals ? parseInt(input.dataset.decimals) : 2
                    });
                    formatter.attachToInput(input);
                });
            };

            window.attachNumberFormatters();
            console.log('[Phase 4] ✅ Number formatter initialized');

            window.numberFormatter = new NumberFormatter();
        }
    } catch (error) {
        console.error('[Phase 4] Error initializing number formatter:', error);
    }

    console.log('[Phase 4] Advanced features initialization complete');

    // Phase 4: Auto-save handler
    window.autoSaveHandler = null;
    window.currentFieldId = null;

    const dataCollectionModalEl = document.getElementById('dataCollectionModal');
    if (dataCollectionModalEl) {
        dataCollectionModalEl.addEventListener('shown.bs.modal', function(event) {
            console.log('[Phase 4] Modal shown event fired');

            const fieldId = window.currentFieldId;
            if (!fieldId) {
                console.warn('[Phase 4] No field ID available for auto-save');
                return;
            }

            if (window.keyboardShortcuts) {
                window.keyboardShortcuts.setModalOpen(true);
            }

            const entityId = {{ current_entity.id if current_entity else 'null' }};
            const reportingDate = document.getElementById('selectedDate')?.value || '{{ selected_date }}';

            if (typeof AutoSaveHandler !== 'undefined' && fieldId && entityId) {
                try {
                    if (window.autoSaveHandler) {
                        window.autoSaveHandler.stop();
                    }

                    window.autoSaveHandler = new AutoSaveHandler({
                        fieldId: fieldId,
                        entityId: entityId,
                        reportingDate: reportingDate,
                        getFormData: function() {
                            const valueInput = document.getElementById('fieldValue');
                            const notesInput = document.getElementById('fieldNotes');

                            const data = {
                                value: valueInput ? valueInput.value : null,
                                notes: notesInput ? notesInput.value : null
                            };

                            if (window.dimensionalDataHandler && window.dimensionalDataHandler.getCurrentData) {
                                data.dimension_values = window.dimensionalDataHandler.getCurrentData();
                            }

                            return data;
                        },
                        onSaveSuccess: function(result) {
                            console.log('[Auto-save] Draft saved successfully:', result);
                        },
                        onSaveError: function(error) {
                            console.error('[Auto-save] Error saving draft:', error);
                        },
                        onDraftRestored: function(draftData) {
                            console.log('[Auto-save] Restoring draft data:', draftData);

                            const valueInput = document.getElementById('fieldValue');
                            const notesInput = document.getElementById('fieldNotes');

                            if (valueInput && draftData.value) {
                                valueInput.value = draftData.value;
                            }
                            if (notesInput && draftData.notes) {
                                notesInput.value = draftData.notes;
                            }

                            if (draftData.dimension_values && window.dimensionalDataHandler && window.dimensionalDataHandler.setCurrentData) {
                                window.dimensionalDataHandler.setCurrentData(draftData.dimension_values);
                            }
                        }
                    });

                    window.autoSaveHandler.start();
                    console.log('[Phase 4] ✅ Auto-save started for field:', fieldId);

                    const formInputs = dataCollectionModalEl.querySelectorAll('input, textarea, select');
                    formInputs.forEach(input => {
                        input.addEventListener('input', () => {
                            if (window.autoSaveHandler) {
                                window.autoSaveHandler.handleFormChange();
                            }
                        });
                    });

                } catch (error) {
                    console.error('[Phase 4] Error initializing auto-save:', error);
                }
            }
        });

        dataCollectionModalEl.addEventListener('hidden.bs.modal', function() {
            console.log('[Phase 4] Modal hidden event fired');

            if (window.keyboardShortcuts) {
                window.keyboardShortcuts.setModalOpen(false);
            }

            if (window.autoSaveHandler) {
                window.autoSaveHandler.stop();
                window.autoSaveHandler = null;
                console.log('[Phase 4] Auto-save stopped');
            }

            window.currentFieldId = null;
        });
    }
});
</script>

{% endblock %}
