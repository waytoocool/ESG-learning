{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block extra_head %}
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Inter Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js for historical trends -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Tailwind Configuration -->
<script>
tailwind.config = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: {
                primary: {
                    50: '#f0fdf4',
                    100: '#dcfce7',
                    200: '#bbf7d0',
                    300: '#86efac',
                    400: '#4ade80',
                    500: '#16a34a',
                    600: '#15803d',
                    700: '#166534',
                    800: '#14532d',
                    900: '#052e16',
                },
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
        }
    }
}
</script>

<style>
    body {
        font-family: 'Inter', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<!-- Phase 3: Computation Context CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/computation_context.css') }}">

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="mx-auto px-2 sm:px-3 lg:px-4 py-2">
        <div class="flex items-center justify-between">
            <!-- Left: Page Title -->
            <div class="flex items-center gap-2">
                <h1 class="text-base font-bold text-gray-900 dark:text-white">Data Entry Dashboard</h1>
            </div>

            <!-- Right: User Info -->
            <div class="flex items-center gap-2">
                <div class="text-right">
                    <p class="text-xs font-medium text-gray-900 dark:text-white">{{ user_name }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">USER {{ current_user.email }} {{ current_user.company.name if current_user.company else '' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Selector Section -->
    <div class="mx-auto px-2 sm:px-3 lg:px-4 py-3">
        <div class="flex items-center justify-between">
            <!-- Entity Switcher -->
            <div class="flex items-center gap-4">
                <!-- Entity Selector -->
                <div class="flex items-center gap-2">
                    {% if user_role == 'ADMIN' and entities|length > 1 %}
                    <span class="material-icons text-gray-500 dark:text-gray-400">apartment</span>
                    <label for="entitySelect" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        Data for:
                    </label>
                    <select id="entitySelect" class="block rounded-lg border-gray-300 dark:border-gray-600 dark:bg-white dark:text-gray-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm py-1.5 px-3">
                        {% for entity in entities %}
                        <option value="{{ entity.id }}" {% if entity.is_current %}selected{% endif %}>
                            {{ entity.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% elif current_entity %}
                    <span class="material-icons text-gray-500 dark:text-gray-400">apartment</span>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Data for:</span>
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ current_entity.name }}</span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        {{ current_entity.type }}
                    </span>
                    {% endif %}
                </div>

                <!-- Fiscal Year Selector -->
                <div class="flex items-center gap-2 border-l border-gray-300 dark:border-gray-600 pl-4">
                    <span class="material-icons text-gray-500 dark:text-gray-400">calendar_today</span>
                    <label for="fySelect" class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        Fiscal Year:
                    </label>
                    <select id="fySelect" class="block rounded-lg border-gray-300 dark:border-gray-600 dark:bg-white dark:text-gray-900 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm py-1.5 px-3">
                        {% for fy_year, fy_label in fy_year_list %}
                        <option value="{{ fy_year }}" {% if fy_year == current_fy_year %}selected{% endif %}>
                            {{ fy_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Toggle Button -->
            <button id="toggleViewBtn" class="inline-flex items-center gap-1 text-sm text-primary-600 dark:text-primary-500 hover:underline">
                <span class="material-icons text-sm">swap_horiz</span>
                Legacy View
            </button>
        </div>
    </div>

    <!-- Error Message Display -->
    {% if error_message %}
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="rounded-lg bg-red-50 dark:bg-red-900/20 p-4 border border-red-200 dark:border-red-800">
            <div class="flex">
                <span class="material-icons text-red-400 mr-3">error</span>
                <p class="text-sm text-red-800 dark:text-red-200">{{ error_message }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Assigned Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-blue-100 dark:bg-blue-900/50 rounded-full">
                                <span class="material-icons text-blue-500 text-2xl">list_alt</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Assigned Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">{{ total_fields }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-green-100 dark:bg-green-900/50 rounded-full">
                                <span class="material-icons text-green-500 text-2xl">check_circle</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Completed Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'complete')|list|length + computed_fields|selectattr('status', 'equalto', 'complete')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-full">
                                <span class="material-icons text-yellow-500 text-2xl">pending</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Pending Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'pending')|list|length + computed_fields|selectattr('status', 'equalto', 'pending')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overdue Fields -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="p-3 bg-red-100 dark:bg-red-900/50 rounded-full">
                                <span class="material-icons text-red-500 text-2xl">warning</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 dark:text-gray-300">Overdue Fields</dt>
                                <dd class="text-3xl font-bold text-gray-900 dark:text-white">
                                    {{ raw_input_fields|selectattr('status', 'equalto', 'overdue')|list|length + computed_fields|selectattr('status', 'equalto', 'overdue')|list|length }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- Search Box -->
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-icons text-gray-400 text-sm">search</span>
                        </div>
                        <input type="text" id="searchMetrics" placeholder="Search metrics..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                    </div>
                </div>

                <!-- Filter: Status -->
                <div class="sm:w-48">
                    <select id="filterStatus" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Statuses</option>
                        <option value="complete">Complete</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>

                <!-- Filter: Category -->
                <div class="sm:w-48">
                    <select id="filterCategory" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Categories</option>
                        <option value="energy">Energy</option>
                        <option value="emissions">Emissions</option>
                        <option value="social">Social</option>
                        <option value="governance">Governance</option>
                    </select>
                </div>

                <!-- Filter: Field Type -->
                <div class="sm:w-48">
                    <select id="filterFieldType" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        <option value="">All Field Types</option>
                        <option value="raw">Raw Input</option>
                        <option value="computed">Computed</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Points Grid -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {% set all_fields = raw_input_fields + computed_fields %}
        {% set fields_by_category = {} %}

        {# Group fields by category/topic #}
        {% for field in all_fields %}
            {% set category = field.topic_name or 'Uncategorized' %}
            {% if category not in fields_by_category %}
                {% set _ = fields_by_category.update({category: []}) %}
            {% endif %}
            {% set _ = fields_by_category[category].append(field) %}
        {% endfor %}

        <!-- Category Icons Mapping -->
        {% set category_icons = {
            'Energy': 'bolt',
            'Emissions': 'cloud',
            'Social': 'groups',
            'Governance': 'gavel',
            'Water': 'water_drop',
            'Waste': 'delete',
            'Biodiversity': 'nature',
            'Uncategorized': 'folder'
        } %}

        <!-- Render Each Category -->
        {% for category, fields in fields_by_category.items() %}
        <div class="mb-8 category-section" data-category="{{ category.lower() }}">
            <!-- Category Header -->
            <div class="flex items-center mb-4">
                <span class="material-icons text-primary-600 dark:text-primary-500 mr-2">
                    {{ category_icons.get(category, 'folder') }}
                </span>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{{ category }}</h2>
                <span class="ml-3 inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">
                    {{ fields|length }} {{ 'field' if fields|length == 1 else 'fields' }}
                </span>
            </div>

            <!-- Fields Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {% for field in fields %}
                {% set is_computed = field.field_name in (computed_fields|map(attribute='field_name')|list) %}

                <div class="field-card bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition-shadow duration-200 overflow-hidden border border-gray-200 dark:border-gray-700 {{ 'computed-field' if is_computed else 'raw-field' }}"
                     data-field-type="{{ 'computed' if is_computed else 'raw' }}"
                     data-field-name="{{ field.field_name|lower }}"
                     data-status="{{ field.status or 'pending' }}">

                    <!-- Card Header with Status Badge -->
                    <div class="px-4 pt-4 pb-2">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 min-h-[2.5rem]">
                                    {{ field.field_name }}
                                </h3>
                            </div>
                            <div class="ml-2">
                                {% if field.status == 'complete' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                    Complete
                                </span>
                                {% elif field.status == 'overdue' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
                                    <span class="material-icons text-xs mr-1">warning</span>
                                    Overdue
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                                    Pending
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="px-4 py-3 space-y-2">
                        <!-- Field Type Badge -->
                        <div class="flex items-center gap-2">
                            {% if is_computed %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                <span class="material-icons text-xs mr-1">functions</span>
                                Computed
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                <span class="material-icons text-xs mr-1">edit</span>
                                Raw Input
                            </span>
                            {% endif %}

                            <!-- Frequency Badge -->
                            {% if field.frequency %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                                {% if field.frequency == 'Annual' %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200
                                {% elif field.frequency == 'Quarterly' %}bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200
                                {% elif field.frequency == 'Monthly' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200
                                {% else %}bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200{% endif %}">
                                {{ field.frequency }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Unit -->
                        {% if field.default_unit %}
                        <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                            <span class="material-icons text-xs mr-1">straighten</span>
                            <span>{{ field.default_unit }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Card Footer with Action Buttons -->
                    <div class="px-4 pb-4">
                        {% if is_computed %}
                        <div class="flex gap-2">
                            <button class="open-data-modal flex-1 inline-flex items-center justify-center px-3 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                    data-field-id="{{ field.field_id }}"
                                    data-field-name="{{ field.field_name }}"
                                    data-field-type="computed">
                                <span class="material-icons text-sm mr-1">visibility</span>
                                View Data
                            </button>
                            <button class="show-computation-context inline-flex items-center justify-center px-3 py-2.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                    data-field-id="{{ field.field_id }}"
                                    title="View Calculation">
                                <span class="material-icons text-sm">functions</span>
                            </button>
                        </div>
                        {% else %}
                        <button class="open-data-modal w-full inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                data-field-id="{{ field.field_id }}"
                                data-field-name="{{ field.field_name }}"
                                data-field-type="raw_input">
                            <span class="material-icons text-sm mr-2">edit</span>
                            Enter Data
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Data Collection Modal (Keep existing Bootstrap modal for compatibility) -->
    <div class="modal fade" id="dataCollectionModal" tabindex="-1" aria-labelledby="dataCollectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h2 class="modal-title" id="dataCollectionModalLabel">
                        Enter Data: <span id="modalFieldName">Field Name</span>
                    </h2>
                    <div class="modal-header-right">
                        <div class="auto-save-status-container"></div>
                        <button type="button" class="btn-close modal-close" data-bs-dismiss="modal" aria-label="Close">
                            &times;
                        </button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="modal-tabs">
                    <button class="tab active" data-tab="entry" id="tab-entry">Current Entry</button>
                    <button class="tab" data-tab="history" id="tab-history">Historical Data</button>
                    <button class="tab" data-tab="info" id="tab-info">Field Info</button>
                </div>

                <!-- Tab Content -->
                <div class="modal-body">
                    <!-- Current Entry Tab -->
                    <div class="tab-content active" id="entry-tab">
                        <!-- Data Entry Form Container (for raw input fields) -->
                        <div id="data-entry-form-container" style="display: block;">
                            <form id="dataEntryForm">
                                <!-- Smart Date Selector -->
                                <div class="mb-4">
                                    <div id="dateSelectorContainer">
                                        <!-- Date selector will be rendered here by DateSelector component -->
                                        <div class="text-center text-muted py-3">
                                            <span class="material-icons">event</span>
                                            <p class="mb-0">Loading dates...</p>
                                        </div>
                                    </div>
                                    <input type="hidden" id="reportingDate" name="reporting_date" required>
                                </div>

                                <div class="mb-3">
                                    <label for="dataValue" class="form-label">Value</label>
                                    <input type="text" class="form-control" id="dataValue" required>
                                </div>

                                <!-- Dimensional Data Matrix Container -->
                                <div class="mb-3" id="dimensionMatrixContainer" style="display: none;">
                                    <!-- Dimensional matrix will be rendered here by DimensionalDataHandler -->
                                </div>

                                <!-- Enhancement #2: Notes/Comments Section -->
                                <div class="mb-3" id="notesSection">
                                    <label for="fieldNotes" class="form-label">
                                        <span class="material-icons text-sm align-middle">comment</span>
                                        Notes / Comments <span class="text-muted">(Optional)</span>
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="fieldNotes"
                                        rows="4"
                                        maxlength="1000"
                                        placeholder="Add context about unusual values, data sources, methodology, or clarifications for reviewers..."
                                    ></textarea>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <small class="form-text text-muted">
                                            <span class="material-icons text-xs align-middle">info</span>
                                            Provide context to help reviewers understand this data entry
                                        </small>
                                        <small class="char-counter text-muted">
                                            <span id="notesCharCount">0</span> / 1000 characters
                                        </small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">File Attachments</label>
                                    <div class="file-upload-area" id="fileUploadArea">
                                        <span class="material-icons-outlined">cloud_upload</span>
                                        <p><strong>Click to upload</strong> or drag and drop</p>
                                        <input type="file" id="fileInput" multiple style="display: none;">
                                    </div>
                                    <div id="fileList" class="mt-2"></div>
                                </div>
                            </form>
                        </div>

                        <!-- Computed Field View Container (for computed fields) -->
                        <div id="computed-field-view-container" style="display: none;">
                            <!-- Computed field view will be rendered here by ComputedFieldView component -->
                        </div>
                    </div>

                    <!-- Historical Data Tab -->
                    <div class="tab-content" id="history-tab">
                        <div id="historicalDataContent">
                            <p class="text-muted">Loading historical data...</p>
                        </div>
                    </div>

                    <!-- Field Info Tab -->
                    <div class="tab-content" id="info-tab">
                        <div id="fieldInfoContent">
                            <p class="text-muted">Loading field information...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-submit" id="submitDataBtn">Save Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Computation Context Modal (Phase 3) -->
    <dialog id="computationContextModal" class="modal">
        <div class="modal-header">
            <h2>Computation Context</h2>
            <button class="btn-close close-btn" onclick="document.getElementById('computationContextModal').close()" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="context-container">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </dialog>
</div>

<!-- Dashboard Modal Styles (external file) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/dashboard_modal.css') }}">

<!-- Keep ALL existing Phase 2, 3, and 4 JavaScript from original template -->
<script>
// Enhancement #2: Load existing notes when opening modal (Global scope)
window.loadExistingNotes = async function(fieldId, entityId, reportingDate) {
    try {
        const response = await fetch(
            `/api/user/v2/field-data/${fieldId}?entity_id=${entityId}&reporting_date=${reportingDate}`
        );

        if (response.ok) {
            const data = await response.json();
            const notesField = document.getElementById('fieldNotes');
            const charCount = document.getElementById('notesCharCount');

            if (data.success && notesField) {
                // Load notes if they exist
                if (data.notes) {
                    notesField.value = data.notes;

                    // Update character counter
                    if (charCount) {
                        const length = data.notes.length;
                        charCount.textContent = length;

                        // Apply color coding
                        if (length > 900) {
                            charCount.classList.add('text-danger');
                            charCount.classList.remove('text-warning');
                        } else if (length > 750) {
                            charCount.classList.add('text-warning');
                            charCount.classList.remove('text-danger');
                        } else {
                            charCount.classList.remove('text-warning', 'text-danger');
                        }
                    }
                } else {
                    // Clear notes field if no notes exist
                    notesField.value = '';
                    if (charCount) {
                        charCount.textContent = '0';
                        charCount.classList.remove('text-warning', 'text-danger');
                    }
                }
            }
        } else if (response.status === 404) {
            // No existing data - clear notes field
            const notesField = document.getElementById('fieldNotes');
            const charCount = document.getElementById('notesCharCount');
            if (notesField) notesField.value = '';
            if (charCount) {
                charCount.textContent = '0';
                charCount.classList.remove('text-warning', 'text-danger');
            }
        }
    } catch (error) {
        console.error('Error loading existing notes:', error);
        // Don't show error to user - just fail silently
        // User can still enter new notes
    }
};

// Phase 1: Basic Modal Functionality
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('dataCollectionModal'));

    // Global date selector instance
    window.currentDateSelector = null;

    /**
     * Helper function to enable/disable form inputs based on date selection
     * @param {boolean} enable - True to enable inputs, false to disable
     */
    window.toggleFormInputs = function(enable) {
        const dataCollectionModal = document.getElementById('dataCollectionModal');
        if (!dataCollectionModal) return;

        // Store the current state globally so dimensional inputs can check it when they're dynamically created
        window.formInputsEnabled = enable;

        // Get all input elements that should be controlled
        const valueInput = document.getElementById('dataValue');
        const notesInput = document.getElementById('fieldNotes');
        const dimensionInputs = dataCollectionModal.querySelectorAll('#dimensionMatrixContainer input, #dimensionMatrixContainer textarea');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const submitBtn = document.getElementById('submitDataBtn');

        // Tooltip message for disabled inputs
        const tooltipMessage = 'Please select a reporting date first';

        if (enable) {
            // Enable all inputs
            if (valueInput) {
                valueInput.disabled = false;
                valueInput.style.cursor = 'text';
                valueInput.style.backgroundColor = '';
                valueInput.removeAttribute('title');
            }
            if (notesInput) {
                notesInput.disabled = false;
                notesInput.style.cursor = 'text';
                notesInput.style.backgroundColor = '';
                notesInput.removeAttribute('title');
            }
            dimensionInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = '';
                input.removeAttribute('title');
            });
            if (fileUploadArea) {
                fileUploadArea.style.pointerEvents = 'auto';
                fileUploadArea.style.opacity = '1';
                fileUploadArea.removeAttribute('title');
            }
            if (fileInput) {
                fileInput.disabled = false;
            }
            if (submitBtn) {
                submitBtn.disabled = false;
            }

            console.log('[Date Validation] Form inputs ENABLED');
        } else {
            // Disable all inputs
            if (valueInput) {
                valueInput.disabled = true;
                valueInput.style.cursor = 'not-allowed';
                valueInput.style.backgroundColor = '#f3f4f6';
                valueInput.setAttribute('title', tooltipMessage);
            }
            if (notesInput) {
                notesInput.disabled = true;
                notesInput.style.cursor = 'not-allowed';
                notesInput.style.backgroundColor = '#f3f4f6';
                notesInput.setAttribute('title', tooltipMessage);
            }
            dimensionInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                input.style.backgroundColor = '#f3f4f6';
                input.setAttribute('title', tooltipMessage);
            });
            if (fileUploadArea) {
                fileUploadArea.style.pointerEvents = 'none';
                fileUploadArea.style.opacity = '0.5';
                fileUploadArea.setAttribute('title', tooltipMessage);
            }
            if (fileInput) {
                fileInput.disabled = true;
            }
            if (submitBtn) {
                submitBtn.disabled = true;
            }

            console.log('[Date Validation] Form inputs DISABLED');
        }
    };

    // Open modal when clicking "Enter Data" buttons
    document.querySelectorAll('.open-data-modal').forEach(button => {
        button.addEventListener('click', async function() {
            const fieldId = this.dataset.fieldId;
            const fieldName = this.dataset.fieldName;
            const fieldType = this.dataset.fieldType;

            // Store field ID and type for use in other handlers
            window.currentFieldId = fieldId;
            window.currentFieldType = fieldType;

            // Pre-populate reportingDate with selected date from dashboard (no fallback to today)
            const selectedDate = document.getElementById('selectedDate')?.value;
            const reportingDateInput = document.getElementById('reportingDate');
            if (reportingDateInput && selectedDate) {
                reportingDateInput.value = selectedDate;
            }

            console.log('Opening modal for field:', fieldId, fieldType, 'with date:', selectedDate);

            const entityId = {{ current_entity.id if current_entity else 'null' }};

            // Enhancement #1: Handle computed fields differently
            if (fieldType === 'computed' && window.computedFieldView) {
                console.log('[Enhancement #1] Opening computed field modal');

                // Toggle containers: show computed view, hide data entry form
                const computedContainer = document.getElementById('computed-field-view-container');
                const formContainer = document.getElementById('data-entry-form-container');
                if (computedContainer && formContainer) {
                    computedContainer.style.display = 'block';
                    formContainer.style.display = 'none';
                }

                // Update modal title for computed fields
                document.getElementById('dataCollectionModalLabel').innerHTML =
                    'View Computed Field: <span id="modalFieldName">' + fieldName + '</span>';

                // Update tab label
                const entryTab = document.querySelector('[data-tab="entry"]');
                if (entryTab) {
                    entryTab.textContent = 'Calculation & Dependencies';
                }

                // Hide modal footer submit button, keep close button visible
                const submitBtn = document.getElementById('submitDataBtn');
                if (submitBtn) submitBtn.style.display = 'none';

                // Bug Fix #1: Use selectedDate or fall back to reportingDate input or current month end
                let dateToUse = selectedDate;
                if (!dateToUse && reportingDateInput) {
                    dateToUse = reportingDateInput.value;
                }
                if (!dateToUse) {
                    // Fallback: Use last day of current month
                    const now = new Date();
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateToUse = lastDay.toISOString().split('T')[0];
                    console.log('[Enhancement #1] Using fallback date:', dateToUse);
                }

                // Store the date for the computed field view
                window.currentReportingDate = dateToUse;

                // Load computed field view with frequency parameter
                if (dateToUse && entityId) {
                    try {
                        // Get frequency from the button's data attribute
                        const fieldCard = event.currentTarget.closest('[data-frequency]');
                        const frequency = fieldCard ? fieldCard.dataset.frequency : 'monthly';

                        await window.computedFieldView.load(fieldId, entityId, dateToUse, frequency);
                    } catch (error) {
                        console.error('[Enhancement #1] Error loading computed field view:', error);
                        const entryTabContent = document.getElementById('entry-tab');
                        if (entryTabContent) {
                            entryTabContent.innerHTML = '<div class="alert alert-danger">Error loading calculation details. Please try again.</div>';
                        }
                    }
                } else {
                    // No date or entity available
                    const entryTabContent = document.getElementById('entry-tab');
                    if (entryTabContent) {
                        entryTabContent.innerHTML = '<div class="alert alert-warning">Unable to load calculation details. Please ensure you are viewing a specific entity and try again.</div>';
                    }
                }
            } else {
                // Raw input field - existing logic
                console.log('[Enhancement #1] Opening raw input field modal');

                // Toggle containers: show data entry form, hide computed view
                const computedContainer = document.getElementById('computed-field-view-container');
                const formContainer = document.getElementById('data-entry-form-container');
                if (computedContainer && formContainer) {
                    computedContainer.style.display = 'none';
                    formContainer.style.display = 'block';
                }

                // Update modal title for raw fields
                document.getElementById('dataCollectionModalLabel').innerHTML =
                    'Enter Data: <span id="modalFieldName">' + fieldName + '</span>';

                // Update tab label
                const entryTab = document.querySelector('[data-tab="entry"]');
                if (entryTab) {
                    entryTab.textContent = 'Current Entry';
                }

                // Show modal footer submit button
                const submitBtn = document.getElementById('submitDataBtn');
                if (submitBtn) submitBtn.style.display = 'inline-flex';

                // Enhancement #2: Load existing notes before showing modal
                if (fieldId && entityId && selectedDate) {
                    await loadExistingNotes(fieldId, entityId, selectedDate);
                }

                // Enhancement #3: Load existing data and attachments
                if (fieldId && entityId && selectedDate && window.fileUploadHandler) {
                    try {
                        const response = await fetch(`/api/user/v2/field-data/${fieldId}?entity_id=${entityId}&reporting_date=${selectedDate}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data_id) {
                                // Set data_id for file uploads
                                window.fileUploadHandler.setDataId(data.data_id);
                                // Load existing attachments
                                await window.fileUploadHandler.loadExistingAttachments(data.data_id);
                                console.log('[Enhancement #3] Loaded existing data_id:', data.data_id);
                            }
                        }
                    } catch (error) {
                        console.log('[Enhancement #3] No existing data found (new entry) - will set data_id after save');
                    }
                }
            }

            modal.show();

            // Check if date is selected and disable inputs accordingly
            const reportingDate = document.getElementById('reportingDate')?.value;
            if (!reportingDate) {
                // No date selected - disable all inputs
                window.toggleFormInputs(false);
                console.log('[Date Validation] Modal opened without date - inputs disabled');
            } else {
                // Date is selected - enable inputs
                window.toggleFormInputs(true);
                console.log('[Date Validation] Modal opened with date:', reportingDate, '- inputs enabled');
            }

            // Initialize date selector after modal is shown
            setTimeout(async () => {
                if (typeof DateSelector !== 'undefined') {
                    try {
                        // Destroy previous instance if exists
                        if (window.currentDateSelector) {
                            window.currentDateSelector.destroy();
                        }

                        const entityId = {{ current_entity.id if current_entity else 'null' }};
                        const fyYear = {{ current_fy_year if current_fy_year else 'null' }};

                        // Create new date selector instance
                        window.currentDateSelector = new DateSelector({
                            fieldId: fieldId,
                            entityId: entityId,
                            fyYear: fyYear,
                            containerId: 'dateSelectorContainer',
                            onDateSelect: async function(dateInfo) {
                                console.log('Date selected:', dateInfo);

                                // Update hidden input for form submission
                                document.getElementById('reportingDate').value = dateInfo.date;

                                // Enable form inputs now that date is selected
                                window.toggleFormInputs(true);
                                console.log('[Date Validation] Date selected:', dateInfo.date, '- inputs enabled');

                                // Start or update auto-save handler with the selected date
                                if (window.autoSaveHandler && window.autoSaveHandler.updateReportingDate) {
                                    window.autoSaveHandler.updateReportingDate(dateInfo.date);
                                    if (!window.autoSaveHandler.isActive) {
                                        window.autoSaveHandler.start();
                                    }
                                    console.log('[Auto-save] Updated reporting date and started auto-save');
                                } else if (typeof AutoSaveHandler !== 'undefined' && window.currentFieldId && entityId) {
                                    // Initialize auto-save if it doesn't exist yet
                                    window.autoSaveHandler = new AutoSaveHandler({
                                        fieldId: window.currentFieldId,
                                        entityId: entityId,
                                        reportingDate: dateInfo.date,
                                        getFormData: function() {
                                            const valueInput = document.getElementById('fieldValue');
                                            const notesInput = document.getElementById('fieldNotes');
                                            const data = {
                                                value: valueInput ? valueInput.value : null,
                                                notes: notesInput ? notesInput.value : null
                                            };
                                            if (window.dimensionalDataHandler) {
                                                const dimensionalData = window.dimensionalDataHandler.getCurrentData();
                                                if (dimensionalData) {
                                                    data.dimension_values = dimensionalData;
                                                }
                                            }
                                            return data;
                                        },
                                        onSaveSuccess: function(result) {
                                            console.log('[Auto-save] Draft saved successfully:', result);
                                        },
                                        onSaveError: function(error) {
                                            console.error('[Auto-save] Error saving draft:', error);
                                        },
                                        onDraftRestored: function(draftData) {
                                            const valueInput = document.getElementById('fieldValue');
                                            const notesInput = document.getElementById('fieldNotes');
                                            if (valueInput && draftData.value) valueInput.value = draftData.value;
                                            if (notesInput && draftData.notes) notesInput.value = draftData.notes;
                                            if (draftData.dimension_values && window.dimensionalDataHandler) {
                                                window.dimensionalDataHandler.setCurrentData(draftData.dimension_values);
                                            }
                                        }
                                    });
                                    window.autoSaveHandler.start();
                                    console.log('[Auto-save] Initialized and started auto-save for date:', dateInfo.date);
                                }

                                // Enhancement #2: Load existing notes for new date
                                if (window.currentFieldId && entityId && dateInfo.date) {
                                    await loadExistingNotes(window.currentFieldId, entityId, dateInfo.date);
                                }

                                // Enhancement #3: Load data_id and attachments for new date
                                if (window.currentFieldId && entityId && dateInfo.date && window.fileUploadHandler) {
                                    try {
                                        const response = await fetch(`/api/user/v2/field-data/${window.currentFieldId}?entity_id=${entityId}&reporting_date=${dateInfo.date}`);
                                        if (response.ok) {
                                            const data = await response.json();
                                            if (data.success && data.data_id) {
                                                window.fileUploadHandler.setDataId(data.data_id);
                                                await window.fileUploadHandler.loadExistingAttachments(data.data_id);
                                                console.log('[Enhancement #3] Date changed - loaded data_id:', data.data_id);
                                            } else {
                                                // No existing data for this date
                                                window.fileUploadHandler.reset();
                                                console.log('[Enhancement #3] Date changed - no existing data, reset file handler');
                                            }
                                        } else {
                                            // No data exists for this date
                                            window.fileUploadHandler.reset();
                                            console.log('[Enhancement #3] Date changed - no data found, reset file handler');
                                        }
                                    } catch (error) {
                                        window.fileUploadHandler.reset();
                                        console.log('[Enhancement #3] Date changed - error loading data, reset file handler');
                                    }
                                }

                                // Reload dimensional matrix with new date
                                if (dimensionalDataHandler && window.currentFieldId) {
                                    const entityId = {{ current_entity.id if current_entity else 'null' }};
                                    const matrixContainer = document.getElementById('dimensionMatrixContainer');

                                    // Show loading state
                                    if (matrixContainer) {
                                        matrixContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading data...</p></div>';
                                    }

                                    try {
                                        const matrix = await dimensionalDataHandler.loadDimensionMatrix(
                                            window.currentFieldId,
                                            entityId,
                                            dateInfo.date
                                        );

                                        // Enhancement #2: Load notes for the selected date
                                        if (window.loadExistingNotes) {
                                            await window.loadExistingNotes(
                                                window.currentFieldId,
                                                entityId,
                                                dateInfo.date
                                            );
                                        }

                                        // Reattach number formatters to inputs
                                        if (matrix.has_dimensions && window.attachNumberFormatters) {
                                            setTimeout(() => {
                                                window.attachNumberFormatters(matrixContainer);
                                                // Apply disabled state to dimensional inputs if date not selected
                                                if (window.formInputsEnabled === false) {
                                                    window.toggleFormInputs(false);
                                                }
                                            }, 50);
                                        }
                                    } catch (error) {
                                        console.error('Error reloading dimension matrix:', error);
                                        if (matrixContainer) {
                                            matrixContainer.innerHTML = '<div class="alert alert-danger">Failed to load data. Please try again.</div>';
                                        }
                                    }
                                }
                            }
                        });

                        // Initialize and load dates
                        const result = await window.currentDateSelector.init();
                        if (result.success) {
                            console.log(`âœ… Date selector loaded with ${result.datesCount} dates`);

                            // BUGFIX #1: Load dimensional matrix for raw input fields AFTER DateSelector is initialized
                            // This fixes the race condition where dimension matrix was trying to load before modal was ready
                            if (window.currentFieldType !== 'computed' && window.dimensionalDataHandler && fieldId && entityId) {
                                try {
                                    console.log('[Modal Init] Loading dimension matrix for field:', fieldId);

                                    // Get reporting date - use selected dashboard date or fall back to current date
                                    const selectedDate = document.getElementById('selectedDate')?.value;
                                    const reportingDateInput = document.getElementById('reportingDate');
                                    let dateToUse = selectedDate;
                                    if (!dateToUse && reportingDateInput) {
                                        dateToUse = reportingDateInput.value;
                                    }
                                    if (!dateToUse) {
                                        // Fallback: Use last day of current month
                                        const now = new Date();
                                        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                                        dateToUse = lastDay.toISOString().split('T')[0];
                                        console.log('[Modal Init] Using fallback date:', dateToUse);
                                    }

                                    // Load dimension matrix
                                    const matrixContainer = document.getElementById('dimensionMatrixContainer');
                                    if (matrixContainer) {
                                        matrixContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading data...</p></div>';
                                    }

                                    const matrix = await window.dimensionalDataHandler.loadDimensionMatrix(
                                        fieldId,
                                        entityId,
                                        dateToUse
                                    );

                                    // Show/hide dimensional matrix based on field
                                    const valueInput = document.getElementById('dataValue');
                                    const valueContainer = valueInput ? valueInput.closest('.mb-3') : null;

                                    if (matrix.has_dimensions) {
                                        if (matrixContainer) matrixContainer.style.display = 'block';
                                        if (valueContainer) valueContainer.style.display = 'none';

                                        // Attach number formatters to dimensional inputs
                                        if (window.attachNumberFormatters) {
                                            setTimeout(() => {
                                                window.attachNumberFormatters(matrixContainer);
                                                console.log('[Modal Init] âœ… Number formatters attached to dimensional inputs');

                                                // Apply disabled state if date not selected
                                                if (window.formInputsEnabled === false) {
                                                    window.toggleFormInputs(false);
                                                }
                                            }, 50);
                                        }
                                    } else {
                                        if (matrixContainer) matrixContainer.style.display = 'none';
                                        if (valueContainer) valueContainer.style.display = 'block';
                                    }

                                    console.log('[Modal Init] âœ… Dimension matrix loaded successfully');
                                } catch (error) {
                                    console.error('[Modal Init] Error loading dimension matrix:', error);
                                    const matrixContainer = document.getElementById('dimensionMatrixContainer');
                                    if (matrixContainer) {
                                        matrixContainer.innerHTML = '<div class="alert alert-danger">Failed to load data. Please try again.</div>';
                                    }
                                }
                            }
                        } else {
                            console.error('âŒ Failed to load date selector:', result.error);
                        }

                    } catch (error) {
                        console.error('Error initializing date selector:', error);
                    }
                } else {
                    console.error('DateSelector class not available');
                }
            }, 100);
        });
    });

    // Tab switching with data loading
    document.querySelectorAll('.modal-tabs .tab').forEach(tab => {
        tab.addEventListener('click', async function() {
            const tabName = this.dataset.tab;

            // Update tab buttons
            document.querySelectorAll('.modal-tabs .tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            // Load data for specific tabs
            if (tabName === 'info' && window.currentFieldId) {
                await loadFieldInfo(window.currentFieldId);
            } else if (tabName === 'history' && window.currentFieldId) {
                await loadFieldHistory(window.currentFieldId);
            }
        });
    });

    // Load Field Info tab content
    async function loadFieldInfo(fieldId) {
        const infoContent = document.getElementById('fieldInfoContent');
        if (!infoContent) return;

        try {
            infoContent.innerHTML = '<p class="text-muted">Loading field information...</p>';

            const response = await fetch(`/api/user/v2/field-metadata/${fieldId}`);
            const data = await response.json();

            if (data.success) {
                let html = '<div class="field-info">';
                html += `<h4>${data.field_name}</h4>`;
                html += `<p class="text-muted">${data.description}</p>`;
                html += '<hr>';
                html += '<dl class="row">';
                html += `<dt class="col-sm-4">Type:</dt><dd class="col-sm-8">${data.field_type === 'computed' ? 'Computed Field' : 'Raw Input'}</dd>`;
                html += `<dt class="col-sm-4">Data Type:</dt><dd class="col-sm-8">${data.data_type || 'N/A'}</dd>`;
                html += `<dt class="col-sm-4">Unit:</dt><dd class="col-sm-8">${data.unit || 'N/A'}</dd>`;
                if (data.framework) {
                    html += `<dt class="col-sm-4">Framework:</dt><dd class="col-sm-8">${data.framework}</dd>`;
                }
                if (data.topic) {
                    html += `<dt class="col-sm-4">Topic:</dt><dd class="col-sm-8">${data.topic}</dd>`;
                }
                if (data.frequency) {
                    html += `<dt class="col-sm-4">Frequency:</dt><dd class="col-sm-8">${data.frequency}</dd>`;
                }
                html += '</dl>';

                // Show formula and dependencies for computed fields
                if (data.field_type === 'computed' && data.formula) {
                    html += '<hr>';
                    html += '<h5>Calculation Formula</h5>';
                    html += `<p><code>${data.formula}</code></p>`;

                    if (data.dependencies && data.dependencies.length > 0) {
                        html += '<h5>Dependencies</h5>';
                        html += '<ul>';
                        data.dependencies.forEach(dep => {
                            html += `<li><strong>${dep.variable}:</strong> ${dep.field_name} ${dep.unit ? '(' + dep.unit + ')' : ''}</li>`;
                        });
                        html += '</ul>';
                    }
                }

                html += '</div>';
                infoContent.innerHTML = html;
            } else {
                infoContent.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Error loading field info:', error);
            infoContent.innerHTML = '<p class="text-danger">Error loading field information. Please try again.</p>';
        }
    }

    // Track pagination state for historical data
    let historyPaginationState = {
        currentFieldId: null,
        currentOffset: 0,
        limit: 20,
        totalCount: 0,
        loadedHistory: []
    };

    // Load Historical Data tab content
    async function loadFieldHistory(fieldId, reset = true) {
        const historyContent = document.getElementById('historicalDataContent');
        if (!historyContent) return;

        // Reset state if loading new field or explicitly requested
        if (reset || historyPaginationState.currentFieldId !== fieldId) {
            historyPaginationState.currentFieldId = fieldId;
            historyPaginationState.currentOffset = 0;
            historyPaginationState.loadedHistory = [];
        }

        try {
            // Show loading indicator
            if (reset) {
                historyContent.innerHTML = '<p class="text-muted">Loading historical data...</p>';
            }

            const response = await fetch(
                `/api/user/v2/field-history/${fieldId}?limit=${historyPaginationState.limit}&offset=${historyPaginationState.currentOffset}`
            );
            const data = await response.json();

            if (data.success) {
                historyPaginationState.totalCount = data.total_count;
                historyPaginationState.loadedHistory.push(...data.history);

                renderHistoryTable(
                    historyPaginationState.loadedHistory,
                    data.total_count,
                    data.has_more,
                    fieldId
                );
            } else {
                historyContent.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Error loading field history:', error);
            historyContent.innerHTML = '<p class="text-danger">Error loading historical data. Please try again.</p>';
        }
    }

    // Enhancement #2: Helper functions for notes display
    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Enhancement #3: Helper function for file size formatting
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    // Render history table with pagination
    function renderHistoryTable(history, totalCount, hasMore, fieldId) {
        const historyContent = document.getElementById('historicalDataContent');

        if (history.length === 0) {
            historyContent.innerHTML = '<p class="text-muted">No historical data available for this field.</p>';
            return;
        }

        let html = '<div class="historical-data">';

        // Header with export buttons
        html += '<div class="d-flex justify-content-between align-items-center mb-3">';
        html += `<h5 class="mb-0">Historical Submissions (Showing ${history.length} of ${totalCount})</h5>`;
        html += '<div class="export-buttons">';
        html += `<button class="btn btn-sm btn-outline-success me-2" onclick="exportFieldHistory('${fieldId}', 'csv')" title="Export to CSV">`;
        html += '<i class="bi bi-download"></i> CSV</button>';
        html += `<button class="btn btn-sm btn-outline-success" onclick="exportFieldHistory('${fieldId}', 'excel')" title="Export to Excel">`;
        html += '<i class="bi bi-file-earmark-excel"></i> Excel</button>';
        html += '</div>';
        html += '</div>';

        html += '<table class="table table-sm table-striped">';
        html += '<thead><tr><th>Reporting Date</th><th>Value</th><th>Notes</th><th>Attachments</th><th>Submitted On</th></tr></thead>';
        html += '<tbody>';

        history.forEach(entry => {
            const submittedDate = entry.created_at ? new Date(entry.created_at).toLocaleDateString() : 'N/A';
            const valueDisplay = entry.value !== null ? `${entry.value} ${entry.unit || ''}` : 'N/A';

            // Enhancement #2: Display notes with preview
            const notesDisplay = entry.has_notes
                ? `<span class="notes-indicator" title="${escapeHtml(entry.notes)}">ðŸ’¬ ${truncateText(entry.notes, 30)}</span>`
                : '<span class="text-muted">-</span>';

            // Enhancement #3: Display attachments
            const attachmentsDisplay = entry.attachments && entry.attachments.length > 0
                ? entry.attachments.map(att => `
                    <a href="/user/v2/api/download-attachment/${att.id}"
                       class="attachment-link"
                       title="${escapeHtml(att.filename)} (${formatFileSize(att.file_size)})"
                       download>
                      <span class="material-icons text-sm">attach_file</span>
                      ${escapeHtml(truncateText(att.filename, 15))}
                    </a>
                  `).join('')
                : '<span class="text-muted">-</span>';

            html += '<tr>';
            html += `<td>${entry.reporting_date}</td>`;
            html += `<td>${valueDisplay}${entry.has_dimensions ? ' <span class="badge badge-info">Dimensional</span>' : ''}</td>`;
            html += `<td>${notesDisplay}</td>`;
            html += `<td class="attachments-cell">${attachmentsDisplay}</td>`;
            html += `<td>${submittedDate}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';

        // Add "Load More" button if there's more data
        if (hasMore) {
            html += '<div class="text-center mt-3">';
            html += `<button class="btn btn-sm btn-outline-primary load-more-btn" onclick="loadMoreHistory('${fieldId}')">`;
            html += 'Load More <i class="bi bi-arrow-down"></i></button>';
            html += '</div>';
        }

        html += '</div>';
        historyContent.innerHTML = html;
    }

    // Load more historical entries
    async function loadMoreHistory(fieldId) {
        historyPaginationState.currentOffset += historyPaginationState.limit;
        await loadFieldHistory(fieldId, false);
    }

    // Export field history to CSV or Excel
    // Make globally accessible for onclick handlers
    window.exportFieldHistory = async function(fieldId, format) {
        try {
            // Get current entity ID
            const entityId = document.getElementById('entitySelect')?.value || '{{ current_user.entity_id }}';

            // Build export URL
            const url = `/api/user/v2/export/field-history/${fieldId}?format=${format}&entity_id=${entityId}`;

            // Show loading feedback
            const buttons = document.querySelectorAll('.export-buttons button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Exporting...';
            });

            // Trigger download
            window.location.href = url;

            // Re-enable buttons after a delay
            setTimeout(() => {
                buttons.forEach(btn => {
                    btn.disabled = false;
                    if (btn.onclick.toString().includes('csv')) {
                        btn.innerHTML = '<i class="bi bi-download"></i> CSV';
                    } else {
                        btn.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Excel';
                    }
                });
            }, 2000);

        } catch (error) {
            console.error('Error exporting field history:', error);
            alert('Failed to export data. Please try again.');

            // Re-enable buttons on error
            const buttons = document.querySelectorAll('.export-buttons button');
            buttons.forEach(btn => {
                btn.disabled = false;
                if (btn.onclick.toString().includes('csv')) {
                    btn.innerHTML = '<i class="bi bi-download"></i> CSV';
                } else {
                    btn.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Excel';
                }
            });
        }
    }

    // Entity switcher (for admins)
    const entitySelect = document.getElementById('entitySelect');
    if (entitySelect) {
        entitySelect.addEventListener('change', function() {
            const entityId = this.value;
            console.log('Switching to entity:', entityId);
            // TODO: Reload dashboard data for new entity
            window.location.reload();
        });
    }

    // Fiscal Year selector - reload dashboard when FY changes
    const fySelect = document.getElementById('fySelect');
    if (fySelect) {
        fySelect.addEventListener('change', function() {
            const fyYear = parseInt(this.value);
            console.log('Switching to FY:', fyYear);

            // Reload dashboard with new FY parameter
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('fy_year', fyYear);

            console.log(`ðŸ”„ Reloading dashboard for FY ${fyYear}...`);
            window.location.href = currentUrl.toString();
        });
    }

    // File upload area
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');

    if (fileUploadArea && fileInput) {
        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#16a34a';
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#dee2e6';
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#dee2e6';

            const files = e.dataTransfer.files;
            console.log('Files dropped:', files.length);
        });

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            console.log('Files selected:', files.length);
        });
    }

    // Toggle button to switch back to legacy dashboard
    const toggleViewBtn = document.getElementById('toggleViewBtn');
    if (toggleViewBtn) {
        toggleViewBtn.addEventListener('click', function() {
            window.location.href = '{{ url_for("user.dashboard") }}';
        });
    }

    // Search and Filter Functionality
    const searchInput = document.getElementById('searchMetrics');
    const filterStatus = document.getElementById('filterStatus');
    const filterCategory = document.getElementById('filterCategory');
    const filterFieldType = document.getElementById('filterFieldType');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilter = filterStatus.value;
        const categoryFilter = filterCategory.value.toLowerCase();
        const fieldTypeFilter = filterFieldType.value;

        document.querySelectorAll('.field-card').forEach(card => {
            const fieldName = card.dataset.fieldName;
            const status = card.dataset.status;
            const fieldType = card.dataset.fieldType;
            const category = card.closest('.category-section').dataset.category;

            const matchesSearch = !searchTerm || fieldName.includes(searchTerm);
            const matchesStatus = !statusFilter || status === statusFilter;
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesFieldType = !fieldTypeFilter || fieldType === fieldTypeFilter;

            if (matchesSearch && matchesStatus && matchesCategory && matchesFieldType) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        // Hide/show category sections if all cards are hidden
        document.querySelectorAll('.category-section').forEach(section => {
            const visibleCards = section.querySelectorAll('.field-card[style="display: block;"], .field-card:not([style*="display"])');
            if (visibleCards.length === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
            }
        });
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (filterStatus) filterStatus.addEventListener('change', applyFilters);
    if (filterCategory) filterCategory.addEventListener('change', applyFilters);
    if (filterFieldType) filterFieldType.addEventListener('change', applyFilters);
});
</script>

<!-- Phase 2: Dimensional Data Handler -->
<script src="{{ url_for('static', filename='js/user_v2/dimensional_data_handler.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/dimensional_grid.css') }}">

<script>
// Initialize Dimensional Data Handler
// Make globally accessible for auto-save integration
window.dimensionalDataHandler = null;

// BUGFIX: Save original entry-tab HTML to restore after computed field view
window.originalEntryTabHTML = null;

document.addEventListener('DOMContentLoaded', function() {
    const dimensionContainer = document.getElementById('dimensionMatrixContainer');
    if (dimensionContainer) {
        window.dimensionalDataHandler = new DimensionalDataHandler(dimensionContainer);
        console.log('[Phase 4] âœ… Dimensional data handler initialized globally');
    }

    // Save original entry-tab HTML for restoration after computed field views
    const entryTab = document.getElementById('entry-tab');
    if (entryTab && !window.originalEntryTabHTML && entryTab.innerHTML.trim().length > 0) {
        window.originalEntryTabHTML = entryTab.innerHTML;
        console.log('[Modal Init] âœ… Original entry-tab HTML saved for restoration (' + entryTab.innerHTML.length + ' chars)');
    } else if (entryTab && entryTab.innerHTML.trim().length === 0) {
        console.log('[Modal Init] âš ï¸ Entry-tab is empty on page load, will save on first modal open');
    }
});

    // REMOVED DUPLICATE EVENT LISTENER: This was causing race conditions and modal content loading failures.
    // Dimension matrix loading is now handled in the modal's 'shown.bs.modal' event (see below).
    // The first event listener (lines 1242-1359) handles button clicks and shows the modal.
    // Then the modal shown event handler initializes DateSelector and loads dimensional data.

    // Enhanced submit button to handle both simple and dimensional data
    const submitBtn = document.getElementById('submitDataBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', async function() {
            try {
                const matrixContainer = document.getElementById('dimensionMatrixContainer');
                const reportingDate = document.getElementById('reportingDate')?.value;
                const fieldId = window.currentFieldId;
                const entityId = {{ current_entity.id if current_entity else 'null' }};

                if (!reportingDate) {
                    alert('Please select a reporting date first.');
                    return;
                }

                if (!fieldId) {
                    alert('Error: Field information not available.');
                    return;
                }

                // Disable button while submitting
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

                // Check if this is dimensional or simple data
                if (matrixContainer.style.display !== 'none' && dimensionalDataHandler && dimensionalDataHandler.currentMatrix) {
                    // Submit dimensional data
                    const result = await dimensionalDataHandler.submitDimensionalData();

                    // Enhancement #3: Enable file uploads after dimensional data save
                    if (result && result.data_id && window.fileUploadHandler) {
                        window.fileUploadHandler.setDataId(result.data_id);
                    }
                } else {
                    // Submit simple data
                    const dataValue = document.getElementById('dataValue')?.value;
                    const notesValue = document.getElementById('fieldNotes')?.value || null;  // Enhancement #2: Get notes

                    const response = await fetch('/user/v2/api/submit-simple-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            field_id: fieldId,
                            entity_id: entityId,
                            reporting_date: reportingDate,
                            raw_value: dataValue,
                            notes: notesValue  // Enhancement #2: Submit notes
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to submit data');
                    }

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Failed to submit data');
                    }

                    console.log('Simple data saved successfully:', result);

                    // Enhancement #3: Enable file uploads after first save
                    if (result.data_id && window.fileUploadHandler) {
                        window.fileUploadHandler.setDataId(result.data_id);
                    }
                }

                // Close modal and reload dashboard
                const modal = bootstrap.Modal.getInstance(document.getElementById('dataEntryModal'));
                if (modal) {
                    modal.hide();
                }

                // Reload dashboard data
                if (window.loadDashboardData) {
                    window.loadDashboardData();
                } else {
                    // Fallback: reload page
                    window.location.reload();
                }

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Save Data';
            } catch (error) {
                console.error('Error submitting data:', error);
                alert('Failed to save data: ' + error.message);

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Save Data';
            }
        });
    }

    // Phase 3: Computation Context Handler
    document.querySelectorAll('.show-computation-context').forEach(button => {
        button.addEventListener('click', function() {
            const fieldId = this.dataset.fieldId;
            const entityId = {{ current_entity.id if current_entity else 'null' }};
            const reportingDate = document.getElementById('selectedDate').value || '{{ selected_date }}';

            if (window.showComputationContext) {
                window.showComputationContext(fieldId, entityId, reportingDate);
            } else {
                console.error('Computation context handler not loaded');
            }
        });
    });
});
</script>

<!-- Phase 3: Load Computation Context Handler -->
<script src="{{ url_for('static', filename='js/user_v2/computation_context_handler.js') }}"></script>

<!-- Phase 4: Advanced Features - CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/phase4_features.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/date_selector.css') }}">

<!-- Enhancement #3: File Upload - CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/file_upload.css') }}">

<!-- Phase 4: Advanced Features - JavaScript Handlers -->
<script src="{{ url_for('static', filename='js/user_v2/auto_save_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/keyboard_shortcuts.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/number_formatter.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/bulk_paste_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/performance_optimizer.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_v2/date_selector.js') }}"></script>

<!-- Enhancement #3: File Upload - JavaScript -->
<script src="{{ url_for('static', filename='js/user_v2/file_upload_handler.js') }}"></script>

<!-- Enhancement #1: Computed Field Modal - CSS & JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_v2/computed_field_view.css') }}">
<script src="{{ url_for('static', filename='js/user_v2/computed_field_view.js') }}"></script>

<script>
// Phase 4: Initialize advanced features (Keep ALL existing Phase 4 code from original)
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Phase 4] Initializing advanced features...');

    // Initialize keyboard shortcuts globally
    try {
        if (typeof KeyboardShortcutHandler !== 'undefined') {
            window.keyboardShortcuts = new KeyboardShortcutHandler({
                onSave: function() {
                    if (autoSaveHandler && autoSaveHandler.isActive) {
                        autoSaveHandler.forceSave();
                    } else {
                        console.log('[Keyboard] Save triggered but auto-save not active');
                    }
                },
                onSubmit: function() {
                    const submitBtn = document.querySelector('#dataCollectionModal .btn-primary[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                },
                onClose: function() {
                    const modal = document.getElementById('dataCollectionModal');
                    if (modal) {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }
                }
            });
            window.keyboardShortcuts.enable();
            console.log('[Phase 4] âœ… Keyboard shortcuts initialized');
        }
    } catch (error) {
        console.error('[Phase 4] Error initializing keyboard shortcuts:', error);
    }

    // Enhancement #3: Initialize file upload handler
    try {
        if (typeof FileUploadHandler !== 'undefined') {
            window.fileUploadHandler = new FileUploadHandler({
                uploadAreaId: 'fileUploadArea',
                fileInputId: 'fileInput',
                fileListId: 'fileList'
            });
            console.log('[Enhancement #3] âœ… File upload handler initialized');
        }
    } catch (error) {
        console.error('[Enhancement #3] Error initializing file upload handler:', error);
    }

    // Enhancement #1: Initialize Computed Field View
    try {
        if (typeof ComputedFieldView !== 'undefined') {
            window.computedFieldView = new ComputedFieldView('computed-field-view-container');
            console.log('[Enhancement #1] âœ… Computed field view initialized');
        }
    } catch (error) {
        console.error('[Enhancement #1] Error initializing computed field view:', error);
    }

    // Initialize performance optimizer
    try {
        if (typeof PerformanceOptimizer !== 'undefined') {
            window.perfOptimizer = new PerformanceOptimizer({
                enableLazyLoading: true,
                enableCaching: true,
                enableWebWorkers: false
            });
            window.perfOptimizer.initialize();
            console.log('[Phase 4] âœ… Performance optimizer initialized');
        }
    } catch (error) {
        console.error('[Phase 4] Error initializing performance optimizer:', error);
    }

    // Initialize number formatter for all number inputs
    try {
        if (typeof NumberFormatter !== 'undefined') {
            window.attachNumberFormatters = function(container) {
                const selector = container
                    ? container.querySelectorAll('input[type="number"], input[data-format="number"]')
                    : document.querySelectorAll('input[type="number"], input[data-format="number"]');

                selector.forEach(input => {
                    if (input._numberFormatter) return;

                    const formatter = new NumberFormatter({
                        fieldType: input.dataset.fieldType || 'DECIMAL',
                        unit: input.dataset.unit || '',
                        decimals: input.dataset.decimals ? parseInt(input.dataset.decimals) : 2
                    });
                    formatter.attachToInput(input);
                });
            };

            window.attachNumberFormatters();
            console.log('[Phase 4] âœ… Number formatter initialized');

            window.numberFormatter = new NumberFormatter();
        }
    } catch (error) {
        console.error('[Phase 4] Error initializing number formatter:', error);
    }

    console.log('[Phase 4] Advanced features initialization complete');

    // Enhancement #2: Notes character counter
    const notesField = document.getElementById('fieldNotes');
    const charCount = document.getElementById('notesCharCount');

    if (notesField && charCount) {
        notesField.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;

            // Change color when approaching limit
            if (length > 900) {
                charCount.classList.add('text-danger');
                charCount.classList.remove('text-warning');
            } else if (length > 750) {
                charCount.classList.add('text-warning');
                charCount.classList.remove('text-danger');
            } else {
                charCount.classList.remove('text-warning', 'text-danger');
            }
        });
        console.log('[Enhancement #2] Notes character counter initialized');
    }

    // Phase 4: Auto-save handler
    window.autoSaveHandler = null;
    window.currentFieldId = null;

    const dataCollectionModalEl = document.getElementById('dataCollectionModal');
    if (dataCollectionModalEl) {
        dataCollectionModalEl.addEventListener('shown.bs.modal', function(event) {
            console.log('[Phase 4] Modal shown event fired');

            const fieldId = window.currentFieldId;
            if (!fieldId) {
                console.warn('[Phase 4] No field ID available for auto-save');
                return;
            }

            if (window.keyboardShortcuts) {
                window.keyboardShortcuts.setModalOpen(true);
            }

            const entityId = {{ current_entity.id if current_entity else 'null' }};
            const reportingDate = document.getElementById('reportingDate')?.value;

            // Only initialize auto-save if reportingDate exists
            if (typeof AutoSaveHandler !== 'undefined' && fieldId && entityId && reportingDate) {
                try {
                    if (window.autoSaveHandler) {
                        window.autoSaveHandler.stop();
                    }

                    window.autoSaveHandler = new AutoSaveHandler({
                        fieldId: fieldId,
                        entityId: entityId,
                        reportingDate: reportingDate,
                        getFormData: function() {
                            const valueInput = document.getElementById('fieldValue');
                            const notesInput = document.getElementById('fieldNotes');

                            const data = {
                                value: valueInput ? valueInput.value : null,
                                notes: notesInput ? notesInput.value : null
                            };

                            // Capture dimensional data if present
                            if (window.dimensionalDataHandler) {
                                if (typeof window.dimensionalDataHandler.getCurrentData === 'function') {
                                    const dimensionalData = window.dimensionalDataHandler.getCurrentData();
                                    if (dimensionalData) {
                                        data.dimension_values = dimensionalData;
                                        console.log('[Phase 4] Captured dimensional data for draft:', dimensionalData);
                                    } else {
                                        console.log('[Phase 4] Dimensional handler exists but returned null data');
                                    }
                                } else {
                                    console.log('[Phase 4] Dimensional handler exists but getCurrentData is not a function');
                                }
                            } else {
                                console.log('[Phase 4] No dimensional handler found');
                            }

                            return data;
                        },
                        onSaveSuccess: function(result) {
                            console.log('[Auto-save] Draft saved successfully:', result);
                        },
                        onSaveError: function(error) {
                            console.error('[Auto-save] Error saving draft:', error);
                        },
                        onDraftRestored: function(draftData) {
                            console.log('[Phase 4] Restoring draft data:', draftData);

                            const valueInput = document.getElementById('fieldValue');
                            const notesInput = document.getElementById('fieldNotes');

                            if (valueInput && draftData.value) {
                                valueInput.value = draftData.value;
                            }
                            if (notesInput && draftData.notes) {
                                notesInput.value = draftData.notes;
                            }

                            // Restore dimensional data if present
                            if (draftData.dimension_values) {
                                console.log('[Phase 4] Draft contains dimensional data:', draftData.dimension_values);
                                if (window.dimensionalDataHandler) {
                                    if (typeof window.dimensionalDataHandler.setCurrentData === 'function') {
                                        console.log('[Phase 4] Restoring dimensional data to handler...');
                                        window.dimensionalDataHandler.setCurrentData(draftData.dimension_values);
                                        console.log('[Phase 4] âœ… Dimensional data restored successfully');
                                    } else {
                                        console.warn('[Phase 4] Dimensional handler exists but setCurrentData is not a function');
                                    }
                                } else {
                                    console.warn('[Phase 4] Draft has dimensional data but no handler available yet');
                                }
                            } else {
                                console.log('[Phase 4] No dimensional data in draft to restore');
                            }
                        }
                    });

                    window.autoSaveHandler.start();
                    console.log('[Phase 4] âœ… Auto-save started for field:', fieldId);

                    const formInputs = dataCollectionModalEl.querySelectorAll('input, textarea, select');
                    formInputs.forEach(input => {
                        input.addEventListener('input', () => {
                            if (window.autoSaveHandler) {
                                window.autoSaveHandler.handleFormChange();
                            }
                        });
                    });

                } catch (error) {
                    console.error('[Phase 4] Error initializing auto-save:', error);
                }
            } else {
                console.log('[Phase 4] Auto-save NOT started - waiting for date selection');
                console.log('[Phase 4] reportingDate:', reportingDate, 'fieldId:', fieldId, 'entityId:', entityId);
            }
        });

        dataCollectionModalEl.addEventListener('hidden.bs.modal', async function() {
            console.log('[Phase 4] Modal hidden event fired');

            if (window.keyboardShortcuts) {
                window.keyboardShortcuts.setModalOpen(false);
            }

            // Save draft immediately if there are unsaved changes
            if (window.autoSaveHandler && window.autoSaveHandler.isDirty) {
                console.log('[Phase 4] Saving draft before closing modal...');
                try {
                    await window.autoSaveHandler.saveDraft();
                    console.log('[Phase 4] Draft saved successfully on modal close');
                } catch (error) {
                    console.error('[Phase 4] Error saving draft on modal close:', error);
                }
            }

            if (window.autoSaveHandler) {
                window.autoSaveHandler.stop();
                window.autoSaveHandler = null;
                console.log('[Phase 4] Auto-save stopped');
            }

            // Enhancement #3: Reset file upload handler
            if (window.fileUploadHandler) {
                window.fileUploadHandler.reset();
                console.log('[Enhancement #3] File upload handler reset');
            }

            // Enhancement #1: Reset computed field view
            if (window.computedFieldView) {
                window.computedFieldView.reset();
                console.log('[Enhancement #1] Computed field view reset');
            }

            // Reset field tracking
            window.currentFieldId = null;
            window.currentFieldType = null;
        });
    }
});
</script>

{% endblock %}
